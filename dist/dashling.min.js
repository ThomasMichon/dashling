!function(){function e(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function t(e,t){return function(){return t.apply(e,arguments)}}function n(e,t){(!t||t.logToConsole)&&console.log(e)}function i(e,t,n){var i=e.getElementsByTagName(t)[0],s=i?i.childNodes[0]:null;return s?s.nodeValue:n}function s(e){var t=0,n=e.substring("2"),i=n.indexOf("H");return i>-1&&(t+=60*Number(n.substring(0,i))*60,n=n.substring(i+1)),i=n.indexOf("M"),i>-1&&(t+=60*Number(n.substring(0,i)),n=n.substring(i+1)),i=n.indexOf("S"),i>-1&&(t+=Number(n.substring(0,i))),t}function a(e,t,n){var i=e.average||0;for(e.average=i+(t-i)/(e.length+1),e.push(t);e.length>n;)r(e)}function r(e){var t=e.shift(),n=e.average;e.average=n+(n-t)/e.length}function o(e){var t="";e=e||document.querySelector("video");for(var n=0;e&&n<e.buffered.length;n++)t+="["+e.buffered.start(n)+"-"+e.buffered.end(n)+"] ";return t}var d={throttle:function(e,t,n,i,s){var a=this;!a._throttleIds&&(a._throttleIds={}),i&&a.clearThrottle(t),a._throttleIds[t]||(a._throttleIds[t]=setTimeout(function(){s||e(),delete a._throttleIds[t]},n),s&&(s=!1,e()))},clearThrottle:function(e){this._throttleIds&&(clearTimeout(this._throttleIds[e]),delete this._throttleIds[e])},clearAllThrottles:function(){if(this._throttleIds){for(var e in this._throttleIds)clearTimeout(this._throttleIds[e]);this._throttleIds=null}}},l={addEventListener:function(e,t){this.__events=this.__events||{};var n=this.__events[e]=this.__events[e]||[];n.push(t)},removeEventListener:function(e,t){var n=this.__events&&this.__events[e];if(n){var i=n.indexOf(t);i>-1&&n.splice(i,1)}},removeAllEventListeners:function(){this.__events=null},raiseEvent:function(e){for(var t=this.__events&&this.__events[e],n=0;t&&n<t.length&&t[n].apply(this,Array.prototype.slice.apply(arguments,[1]))!==!1;n++);}},u={sessionStateChange:"sessionstatechange",download:"download"},m={manifestDownload:"manifestDownload",manifestParse:"manifestParse",mediaSourceInit:"mediaSourceInit",mediaSourceAppend:"mediaSourceAppend",initSegmentDownload:"initSegmentDownload",mediaSegmentDownload:"fragmentDownload",append:"append"},g={error:-1,idle:0,initializing:1,buffering:2,playing:4,paused:5},_={error:-1,idle:0,downloading:1,downloaded:2,appending:3,appended:4};window.Dashling=function(){this.settings=e({},Dashling.Settings)},e(Dashling,{Event:u,SessionState:g,FragmentState:_,Error:m}),Dashling.prototype={_streamController:null,_sessionIndex:0,state:g.idle,lastError:null,load:function(e,t){var n=this;n.reset(),n._setState(g.initializing),n._videoElement=e,n._initializeMediaSource(e),n._initializeManifest(t)},dispose:function(){this.reset()},reset:function(){var e=this;if(e.startTime=null,e.timeAtLoad=null,e.lastError=null,e._streamController&&(e._streamController.dispose(),e._streamController=null),e._parser&&(e._parser.dispose(),e._parser=null),e._videoElement){e.settings.manifest=null;try{e._videoElement.pause()}catch(t){}e._videoElement=null}e.videoElement=null,e._mediaSource=null,e._setState(g.idle)},getRemainingBuffer:function(){return this._streamController?this._streamController.getRemainingBuffer():0},getBufferRate:function(){return this._streamController?this._streamController.getBufferRate():0},getPlayingQuality:function(e){return this._streamController?this._streamController.getPlayingQuality(e):this.settings[e]},getBufferingQuality:function(e){return this._streamController?this._streamController.getBufferingQuality(e):this.settings[e]},getMaxQuality:function(e){var t=this.settings.manifest?this.settings.manifest.streams[e]:null;return t?t.qualities.length-1:0},_setState:function(e,t){this.state!=e&&(this.state=e,this.lastError=t,e==g.error&&this._streamController&&this._streamController.dispose(),this.raiseEvent(u.sessionStateChange,e))},_initializeMediaSource:function(e){function t(){n.removeEventListener("sourceopen",t),i._sessionIndex==s&&(i._mediaSource=n,i._tryStart())}var n,i=this,s=i._sessionIndex;i.raiseEvent(u.initMediaSourceStart);try{n=new MediaSource}catch(a){i._setState(g.error,Dashling.Error.mediaSourceInit)}n.addEventListener("sourceopen",t,!1),e.autoplay=!0,e.src=window.URL.createObjectURL(n)},_initializeManifest:function(e){function t(e){i._loadIndex==s&&i.state!=g.error&&(i.settings.manifest=e,i._tryStart())}function n(e){i._loadIndex==s&&i._setState(g.error,e)}var i=this,s=i._loadIndex;i.settings.manifest?t(i.settings.manifest):(i._parser=new Dashling.ManifestParser(i.settings),i._parser.addEventListener(Dashling.Event.download,function(e){i.raiseEvent(Dashling.Event.download,e)}),this._parser.parse(e,t,n))},_tryStart:function(){var e=this;e.state!=g.error&&e._mediaSource&&e.settings.manifest&&(e._mediaSource.duration=e.settings.manifest.mediaDuration,e._streamController=new Dashling.StreamController(e._videoElement,e._mediaSource,e.settings),e._streamController.addEventListener(Dashling.Event.download,function(t){e.raiseEvent(Dashling.Event.download,t)}),e._streamController.addEventListener(Dashling.Event.sessionStateChange,function(t,n){e._setState(t,n)}),e._streamController.start())}},e(Dashling.prototype,l),Dashling.Settings={manifest:null,startTime:0,isABREnabled:!0,isRBREnabled:!1,targetQuality:{audio:2,video:2},shouldAutoPlay:!0,logToConsole:!0,safeBufferSeconds:12,maxBufferSeconds:119.5,maxConcurrentRequests:{audio:4,video:6},maxSegmentLeadCount:{audio:3,video:5},defaultBandwidth:520,requestTimeout:3e4,maxRetries:3,delaysBetweenRetries:[200,1500,3e3]},Dashling.ManifestParser=function(e){var t=this;t._requestManager=new Dashling.RequestManager(!1,e),t._requestManager.addEventListener(Dashling.Event.download,function(e){t.raiseEvent(u.download,e)})},Dashling.ManifestParser.prototype={_parseIndex:0,dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},parse:function(e,t,n){function i(){if(a._parseIndex==r){{var e;o.data}try{e=a._parseManifest(o.data)}catch(i){n(m.manifestParse+" ("+i+")",o)}e&&(e.request=o,t(e))}}function s(){a._parseIndex==r&&n(m.manifestDownload+" ("+o.statusCode+")")}var a=this,r=++a._parseIndex,o={url:e,requestType:"manifest"};this._requestManager.load(o,!1,i,s)},_parseManifest:function(e){var t,n={},a=new DOMParser,r=a.parseFromString(e,"text/xml");n.baseUrl=i(r,"BaseURL",""),n.mediaDuration=s(r.documentElement.getAttribute("mediaPresentationDuration")),n.streams={};var o=[r.querySelector("AdaptationSet[contentType='audio']"),r.querySelector("AdaptationSet[contentType='video']")];if(!o[0]||!o[1])throw"Missing adaptations";for(var d=0;d<o.length;d++){var l=o[d];if(l){var u=l.getAttribute("contentType"),m=l.querySelectorAll("Representation"),g=l.querySelector("SegmentTemplate"),_=l.querySelectorAll("S"),h=n.streams[u]={streamType:u,mimeType:l.getAttribute("mimeType"),codecs:l.getAttribute("codecs"),initUrlFormat:g.getAttribute("initialization"),fragUrlFormat:g.getAttribute("media"),qualities:[],timeline:[]},f=g.getAttribute("timescale");if(!_||!_.length)throw"Missing timeline";for(var c=0;c<m.length;c++){var v=m[c],p={id:v.getAttribute("id"),bandwidth:v.getAttribute("bandwidth")};v.getAttribute("height")&&(p.width=Number(v.getAttribute("width")),p.height=Number(v.getAttribute("height"))),h.qualities.push(p)}for(var S=0,y=0;y<_.length;y++){var I=_[y],q=Number(I.getAttribute("r"))||0,T=Number(I.getAttribute("d"));for(t=0;q>=t;t++)h.timeline.push({start:S,startSeconds:S/f,length:T,lengthSeconds:T/f}),S+=T}}}return n}},e(Dashling.ManifestParser.prototype,l),Dashling.StreamController=function(e,n,i){var s=this;s._onVideoSeeking=t(s,s._onVideoSeeking),s._onVideoError=t(s,s._onVideoError),s._onPauseStateChange=t(s,s._onPauseStateChange),s._appendNextFragment=t(s,s._appendNextFragment),s._onThrottledSeek=t(s,s._onThrottledSeek),s._videoElement=e,s._videoElement.addEventListener("seeking",s._onVideoSeeking),s._videoElement.addEventListener("error",s._onVideoError),s._videoElement.addEventListener("play",s._onPauseStateChange),s._videoElement.addEventListener("pause",s._onPauseStateChange),s._mediaSource=n,s._settings=i,s._startTime=(new Date).getTime(),s._timeSinceLastBuffer=(new Date).getTime(),s._bufferRate=[],s._appendedSeconds=0,s._streams=[s._audioStream=new Dashling.Stream("audio",n,e,i),s._videoStream=new Dashling.Stream("video",n,e,i)];for(var a=0;a<s._streams.length;a++)s._streams[a].addEventListener(Dashling.Event.download,function(e){s.raiseEvent(Dashling.Event.download,e)});s._requestTimerIds=[0,0];var r=s._audioStream.fragments[0].time.lengthSeconds;i.startTime&&r&&(this._appendIndex=Math.max(0,Math.min(s._audioStream.fragments.length-1,Math.floor((i.startTime-.5)/r))))},Dashling.StreamController.prototype={_nextStreamIndex:0,_appendIndex:0,_audioDownloadIndex:0,_videoDownloadIndex:0,_simultaneousDownloadsPerStream:2,_maxSegmentsAhead:2,_nextRequestTimerId:0,_seekingTimerId:0,dispose:function(){var e=this;e.isDisposed=!0,e._videoElement&&(e._videoElement.removeEventListener("seeking",e._onVideoSeeking),e._videoElement.removeEventListener("error",e._onVideoError),e._videoElement.removeEventListener("play",e._onPauseStateChange),e._videoElement.removeEventListener("pause",e._onPauseStateChange),e._videoElement=null);for(var t=0;e._streams&&t<e._streams.length;t++)e._streams[t].dispose();e._requestTimerIds[0]&&(clearTimeout(e._requestTimerIds[0]),e._requestTimerIds[0]=0),e._requestTimerIds[1]&&(clearTimeout(e._requestTimerIds[1]),e._requestTimerIds[1]=1),e._seekingTimerId&&(clearTimeout(e._seekingTimerId),e._seekingTimerId=0),e._mediaSource=null,e.removeAllEventListeners()},start:function(){this._setIsPlayAllowed(!1),this._loadNextFragment()},getPlayingQuality:function(e){var t=0;if(!this.isDisposed){var n=this._videoElement.currentTime,i="video"==e?this._videoStream:e._audioStream,s=Math.min(i.fragments.length-1,Math.floor(n/i.fragments[0].time.lengthSeconds)),t=i.fragments[s].qualityIndex;t>=0?t:i.qualityIndex}return t},getBufferingQuality:function(e){var t="video"==e?this._videoStream:this._audioStream;return t.qualityIndex},getBufferRate:function(){return this._bufferRate.average||0},getRemainingBuffer:function(){var e=0;if(!this.isDisposed)for(var t=Math.max(.5,this._videoElement.currentTime),n=(this._videoElement.duration-t,this._videoElement.buffered),i=0;i<n.length;i++)if(t>=n.start(i)&&t<=n.end(i)){e=n.end(i)-t;break}return e},getTimeUntilUnderrun:function(){var e=Number.MAX_VALUE;if(!this.isDisposed){var t=this._videoElement.currentTime,n=this._videoElement.duration-t-.5,i=this.getRemainingBuffer(),s=this.getBufferRate(),a=i/this._settings.safeBufferSeconds;if(a=Math.min(1,Math.max(0,a)),n>i){var r=i*s;e=i+a*r,(e>n||e>.5*this._settings.maxBufferSeconds)&&(e=Number.MAX_VALUE)}}return e},_loadNextFragment:function(){function e(e,n){t.isDisposed||(t._requestTimerIds[e]&&clearTimeout(t._requestTimerIds[e]),t._requestTimerIds[e]=setTimeout(function(){t._requestTimerIds[e]=0,t._loadNextFragment()},n))}var t=this;if(t._streams){for(var n=t._getDownloadCandidates(),i=0;i<n.length;i++)for(var s=n[i],a=t._streams[i],r=0;r<s.length;r++){var o=s[r],d=(a.fragments[o],a.fragments[o-1]),l=d&&d.activeRequest&&d.activeRequest.state==_.downloading?d.activeRequest:null,u=a.getRequestStaggerTime(),m=l?(new Date).getTime()-l.startTime:0;if(l&&!(m>=u)){e(i,u-m);break}a.load(o,this._appendNextFragment)}n[0].length||n[1].length||!n.hitMaxLimit||e(0,300)}},_appendNextFragment:function(){var e,t,n=this,i=this._streams,s=n._settings.startTime||n._videoElement.currentTime;if(i&&i.length&&n._mediaSource&&"closed"!=n._mediaSource.readyState){for(;n._appendIndex<i[0].fragments.length;){var r=!0,o=!0;for(t=0;t<i.length;t++)e=i[t],r&=e.canAppend(n._appendIndex),o&=e.fragments[n._appendIndex].state==_.appended&&!e.isMissing(n._appendIndex,s);if(r)for(o=!1,t=0;t<i.length;t++){var e=i[t];e.append(n._appendIndex,n._appendNextFragment),o&=e.fragments[n._appendIndex].state==_.appended}if(!o)break;var d=n._streams[0].fragments[n._appendIndex];if(!d.activeRequest._hasUpdatedBufferRate){d.activeRequest._hasUpdatedBufferRate=!0,n._appendedSeconds+=d.time.lengthSeconds;var l=(new Date).getTime(),u=(l-this._startTime)/1e3;a(n._bufferRate,n._appendedSeconds/(u||.1),3)}n._appendIndex++,n._settings.startTime&&(n._videoElement.currentTime=n._settings.startTime,n._settings.startTime=0),this._isPlayAllowed||this._setIsPlayAllowed(this.getTimeUntilUnderrun()>this._settings.safeBufferSeconds)}n._appendIndex==i[0].fragments.length&&"open"==n._mediaSource.readyState&&n._mediaSource.endOfStream(),n._loadNextFragment()}},_getDownloadCandidates:function(){var e,t=this,i=[[],[]],s=(t._streams,t._settings),a=t._audioStream.fragments[0].time.lengthSeconds,r=t._settings.startTime||t._videoElement.currentTime,d=Math.floor(r/a),l=d+Math.ceil(s.maxBufferSeconds/a),u=-1,m=-1,g=t._videoStream.fragments.length;for(e=t._appendIndex;l>=e&&g>e;e++){if(this._audioStream.isMissing(e,r)||this._videoStream.isMissing(e,r)){var h=this._videoStream.fragments[e];n("Missing fragment reset: index="+e+" ["+h.time.startSeconds+"] ranges: "+o(t._videoElement),t._settings),this._audioStream.fragments[e].state=this._videoStream.fragments[e].state=_.idle}t._audioStream.assessQuality(),t._videoStream.assessQuality();var f=this._audioStream.canLoad(e),c=this._videoStream.canLoad(e);-1==m&&this._audioStream.fragments[e].state<_.downloaded&&(m=e+s.maxSegmentLeadCount.video),-1==u&&this._videoStream.fragments[e].state<_.downloaded&&(u=e+s.maxSegmentLeadCount.audio);var v=-1==u||u>=e,p=-1==m||m>=e,S=this._audioStream.getActiveRequestCount()+i[0].length+1<s.maxConcurrentRequests.audio,y=this._videoStream.getActiveRequestCount()+i[1].length<s.maxConcurrentRequests.video;if(f&&v&&S&&i[0].push(e),c&&p&&y&&i[1].push(e),!(S&&v||y&&p))break}return e>l&&g>e&&(i.hitMaxLimit=!0),i},_setIsPlayAllowed:function(e){this._isPlayAllowed!==e&&(this._isPlayAllowed=e,this._videoElement.playbackRate=e?1:0,this._onPauseStateChange())},_onVideoSeeking:function(){this._seekingTimerId&&clearTimeout(this._seekingTimerId),this._settings.startTime=0,this._seekingTimerId=setTimeout(this._onThrottledSeek,500)},_onThrottledSeek:function(){var e=this,t=e._videoElement.currentTime,i=Math.floor(Math.max(0,t-.5)/e._streams[0].fragments[0].time.lengthSeconds);if(e._setIsPlayAllowed(!1),e._seekingTimerId=0,n("Throttled seek: "+e._videoElement.currentTime,e._settings),e._nextRequestTimerId&&(clearTimeout(e._nextRequestTimerId),e._nextRequestTimerId=0),e._appendIndex<i)for(var s=0;s<e._streams.length;s++)e._streams[s].abortAll();e._appendIndex=i,e._appendNextFragment()},_onVideoError:function(){var e=this._videoElement.error,t=e.code;for(var n in e)if(e[n]==t&&"code"!=n){t=n;break}this.raiseEvent(Dashling.Event.sessionStateChange,g.error,t)},_onPauseStateChange:function(){this.raiseEvent(Dashling.Event.sessionStateChange,this._isPlayAllowed?this._videoElement.paused?g.paused:g.playing:g.buffering)}},e(Dashling.StreamController.prototype,l),e(Dashling.StreamController.prototype,d);var h="Dashling.Stream.bytesPerSecond";Dashling.Stream=function(t,n,i,s){var a=this,r=s.manifest.streams[t];e(a,{fragments:[],qualityIndex:Math.max(0,Math.min(r.qualities.length-1,s.targetQuality[t])),_startTime:(new Date).getTime(),_appendLength:0,_initializedQualityIndex:-1,_initRequestManager:new Dashling.RequestManager(!1,s),_requestManager:new Dashling.RequestManager("video"==t,s),_streamType:t,_mediaSource:n,_videoElement:i,_settings:s,_manifest:s.manifest,_streamInfo:r,_buffer:null,_bufferRate:[],_initSegments:[]}),a._requestManager.addEventListener(Dashling.Event.download,function(e){a.raiseEvent(u.download,e)}),a._initRequestManager.addEventListener(Dashling.Event.download,function(e){a.raiseEvent(u.download,e)});for(var o=r.timeline.length,d=0;o>d;d++)a.fragments.push({state:_.idle,qualityIndex:-1,qualityId:"",requestType:"media",fragmentIndex:d,time:r.timeline[d],activeRequest:null,requests:[]})},Dashling.Stream.prototype={dispose:function(){this.isDisposed=!0,this._requestManager&&this._requestManager.dispose(),this.clearAllThrottles(),this.removeAllEventListeners()},abortAll:function(){this._requestManager.abortAll()},canAppend:function(e){var t=this.fragments[e],n=t?this._initSegments[t.qualityIndex]:null,i=this._initSegments[this._streamInfo.qualities.length-1];return t&&t.state==_.downloaded&&n&&n.state>=_.downloaded&&i&&i.state>=_.downloaded},append:function(e,t){function i(){if(!r.isDisposed){var e=l[0];if(l.length){u.addEventListener("update",s);try{n("Append started: "+r._streamType+" "+e.qualityId+" "+e.requestType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),r._settings),u.appendBuffer(e.data)}catch(i){e.state=o.state=_.error,r._isAppending=!1,t()}}else{o.state=_.appended,r._isAppending=!1;var d=((new Date).getTime()-r._startTime)/1e3;r._appendLength+=o.time.lengthSeconds,a(r._bufferRate,r._appendLength/d,5),t(o)}}}function s(){if(!r.isDisposed){var e=l[0];u.removeEventListener("update",s),e.timeAtAppended=(new Date).getTime()-e.startTime,e.state=_.appended,e.clearDataAfterAppend&&(e.data=null),"init"===e.requestType&&(r._initializedQualityIndex=e.qualityIndex),n("Append complete: "+r._streamType+" "+e.qualityId+" "+e.requestType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),r._settings),l.shift(),i()}}var r=this,o=r.fragments[e],d=r._streamInfo.qualities.length-1,l=[],u=r._buffer;!r._isAppending&&o&&o.state===_.downloaded&&(r._isAppending=!0,o.state=_.appending,u||(u=r._getSourceBuffer(),d>o.qualityIndex&&l.push(r._initSegments[d])),l.push(r._initSegments[o.qualityIndex]),l.push(o.activeRequest),i())},getBufferRate:function(){return this._bufferRate.average||0},getActiveRequestCount:function(){return this._requestManager.getActiveRequestCount()},getRequestStaggerTime:function(){return Math.round(1400*this._estimateDownloadSeconds(this.qualityIndex))},isMissing:function(e,t){var n=this.fragments[e];return n.state==_.appended&&!this.isBuffered(e,t)},isBuffered:function(e,t){var n=this.fragments[e],i=!1;if(n){var s=this._buffer.buffered,a=n.time,r=a.startSeconds<.3,o=a.startSeconds+a.lengthSeconds+.3>=this._manifest.mediaDuration,d=Math.max(t,a.startSeconds+(r?.5:.05)),l=a.startSeconds+a.lengthSeconds-(o?.8:.05);try{for(var u=0;u<s.length;u++)if(s.start(u)<=d&&s.end(u)>l){i=!0;break}}catch(m){i=!0}}return i},canLoad:function(e){return this.fragments[e].state<=_.idle},load:function(e,t){function i(e){if(!a.isDisposed){r.state=_.downloaded;var i=Math.round(e.timeAtLastByte-(e.timeAtEstimatedFirstByte||e.timeAtFirstByte)),s=e.timeAtLastByte-i;n("Download complete: "+e.qualityId+" "+e.requestType+" index: "+e.fragmentIndex+" waiting: "+s+"ms receiving: "+i,a._settings),t(r)}}function s(){o.isAborted?(r.state=_.idle,r.activeRequest=null,r.requests=[]):r.state=_.error}var a=this,r=this.fragments[e];if(r&&r.state<=_.idle){r.state=_.downloading,r.qualityIndex=a.qualityIndex,r.qualityId=this._streamInfo.qualities[r.qualityIndex].id,a._loadInitSegment(this.qualityIndex,t);var o={url:a._getUrl(e,r),state:_.downloading,fragmentIndex:e,requestType:"media",qualityIndex:r.qualityIndex,qualityId:r.qualityId,clearDataAfterAppend:!0};r.activeRequest=o,r.requests.push(o),n("Download started: "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index="+o.fragmentIndex:"")+" time="+((new Date).getTime()-a._startTime)+"ms stagger="+a.getRequestStaggerTime()+"ms",a._settings),a._requestManager.load(o,!0,i,s)}},assessQuality:function(){var e=this,t=e._settings,i=e._requestManager.getAverageBytesPerSecond(),s=e._streamInfo.qualities.length-1;if(i?"video"===this._streamType&&localStorage.setItem(h,i):i=parseFloat(localStorage.getItem(h)),t.isABREnabled&&i)if(t.isRBREnabled)e.qualityIndex=Math.round(Math.random()*s);else{for(var a=0,r="Quality check "+e._streamType+": bps="+Math.round(i),o=e._streamInfo.timeline[0].lengthSeconds,d=.4*o,l=0;s>=l;l++){var u=e._estimateDownloadSeconds(l,0);r+=" "+l+"="+u.toFixed(2)+"s",o>u+d&&(a=l)}e.throttle(function(){n(r,e._settings)},"assess",1e3,!1,!1),e.qualityIndex=a}else e.qualityIndex=Math.min(e._streamInfo.qualities.length-1,t.targetQuality[e._streamType])},_estimateDownloadSeconds:function(e,t){var n=this,i=n._streamInfo.qualities[e],s=n._streamInfo.timeline[t||0].lengthSeconds,a=i.bandwidth/8,r=a*s,o=n._requestManager.getAverageBytesPerSecond();o?"video"===this._streamType&&localStorage.setItem(h,o):o=parseFloat(localStorage.getItem(h));var d=o||n._settings.defaultBandwidth;return r/d},_getSourceBuffer:function(){return this._buffer||(this._buffer=this._mediaSource.addSourceBuffer(this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs)),this._buffer},_loadInitSegment:function(e,t){function i(){a.isDisposed||(o.state=_.downloaded,n("Download complete: "+a._streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),a._settings),t(o))}function s(){a.isDisposed||(o.state=_.error)}var a=this,r=this._streamInfo.qualities.length-1;if(e!=r&&a._loadInitSegment(r,t),!a._initSegments[e]){var o=a._initSegments[e]={url:this._getInitUrl(e),state:_.downloading,timeAtDownloadStarted:(new Date).getTime(),requestType:"init",qualityIndex:e,qualityId:this._streamInfo.qualities[e].id};n("Download started: "+a._streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),a._settings),a._initRequestManager.load(o,!0,i,s)}},_getInitUrl:function(e){var t=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[e].id);return this._manifest.baseUrl+t},_getUrl:function(e,t){var n=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",t.qualityId).replace("$Time$",t.time.start);return this._manifest.baseUrl+n}},e(Dashling.Stream.prototype,l),e(Dashling.Stream.prototype,d),Dashling.RequestManager=function(t,n){e(this,{_settings:n,_activeRequests:{},_waitTimes:[],_receiveTimes:[],_bytesPerSeconds:[],_shouldRecordStats:t,_maxRetries:n.maxRetries,_delaysBetweenRetries:n.delaysBetweenRetries})};Dashling.RequestManager.prototype={_activeRequestCount:0,_totalRequests:0,_xhrType:XMLHttpRequest,dispose:function(){this.abortAll(),this.removeAllEventListeners()},getActiveRequestCount:function(){return this._activeRequestCount},abortAll:function(){for(var e in this._activeRequests){var t=this._activeRequests[e];n("Aborting request: "+t.url),t.isAborted=!0,t.abort()}this._activeRequests={}},load:function(e,t,n,i){function s(){function u(){0==m.status&&e.timeAtLastByte>=r._settings.requestTimeout&&(m.isTimedOut=!0),!m.isAborted&&++d<o?(e.retryCount++,setTimeout(s,l[Math.min(l.length-1,d)])):(e.state=_.error,e.hasError=!0,e.isAborted=m.isAborted,e.statusCode=m.isAborted?"aborted":m.isTimedOut?"timeout":m.status,i&&i(e))}var m=new r._xhrType,g=++r._totalRequests;r._activeRequests[g]=m,r._activeRequestCount++,m.url=e.url,m.open("GET",e.url,!0),t&&(m.responseType="arraybuffer"),m.timeout=r._settings.requestTimeout,m.onreadystatechange=function(){m.readyState>0&&e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime)},m.onprogress=function(t){e.progressEvents.push({timeFromStart:(new Date).getTime()-e.startTime,bytesLoaded:t.lengthComputable?t.loaded:-1}),r._postProgress(e.progressEvents)},m.onloadend=function(){if(delete r._activeRequests[g],r._activeRequestCount--,e.timeAtLastByte=(new Date).getTime()-e.startTime,m.status>=200&&m.status<=299){if(e.bytesLoaded=t?m.response.byteLength:m.responseText.length,m.onreadystatechange(),e.progressEvents.length>2){var i=e.progressEvents[e.progressEvents.length-1],s=e.progressEvents[0],o=i.timeFromStart-s.timeFromStart,d=i.bytesLoaded-s.bytesLoaded;e.bytesPerMillisecond=d/o,e.timeAtFirstByte=e.timeAtLastByte-e.bytesLoaded/e.bytesPerMillisecond}a(r._waitTimes,e.timeAtFirstByte,20),a(r._receiveTimes,e.timeAtLastByte-e.timeAtFirstByte,20),e.data=t?new Uint8Array(m.response):m.responseText,e.statusCode=m.status,e.state=_.downloaded,n&&n(e)}else u(e);r.raiseEvent(Dashling.Event.download,e)},e.state=_.downloading,e.progressEvents=[],e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.startTime=(new Date).getTime(),m.send()}var r=this,o=this._maxRetries,d=-1,l=this._delaysBetweenRetries;e.retryCount=0,s()},_postProgress:function(e){if(e.length>2){var t=e[e.length-1],n=e[0],i=t.bytesLoaded-n.bytesLoaded;if(i>1e4){var s=t.timeFromStart-n.timeFromStart;s>1&&a(this._bytesPerSeconds,1e3*i/s,20)}}},getAverageWait:function(){return this._waitTimes.average||0},getAverageReceive:function(){return this._receiveTimes.average||0},getAverageBytesPerSecond:function(){return this._bytesPerSeconds.average||0}},e(Dashling.RequestManager.prototype,l)}();