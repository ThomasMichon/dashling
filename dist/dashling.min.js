!function(){function t(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])}function e(t,e){return function(){return e.apply(t,arguments)}}function a(t){for(var e=0,a=0;t&&a<t.length;a++)e+=t[a];return e/(t.length||1)}function i(t,e,a){var i=t.getElementsByTagName(e)[0],n=i?i.childNodes[0]:null;return n?n.nodeValue:a}function n(t){var e=0,a=t.substring("2"),i=a.indexOf("H");return i>-1&&(e+=60*Number(a.substring(0,i))*60,a=a.substring(i+1)),i=a.indexOf("M"),i>-1&&(e+=60*Number(a.substring(0,i)),a=a.substring(i+1)),i=a.indexOf("S"),i>-1&&(e+=Number(a.substring(0,i))),e}var s={on:function(t,e){this.__events=this.__events||{};var a=this.__events[t]=this.__events[t]||[];a.push(e)},off:function(t,e){var a=this.__events&&this.__events[t];if(a){a.indexOf(e)}},raiseEvent:function(t,e){for(var a=this.__events&&this.__events[t],i=0;a&&i<a.length&&a[i].call(this,e)!==!1;i++);}};window.Dashling=function(){this._tryAppendFragments=e(this,this._tryAppendFragments),this.settings={targetAudioQuality:0,targetVideoQuality:0,isABREnabled:!0}},Dashling.prototype={_videoElement:null,_mediaSource:null,_audioStream:null,_videoStream:null,_fragmentIndex:0,load:function(t,e){this._videoElement=t,this._initializeMediaSource(t),this._loadManifest(e)},_initializeMediaSource:function(t){function e(){i._mediaSource=n,i._tryStart()}function a(){alert("error initializing media source")}var i=this,n=new MediaSource;n.addEventListener("sourceopen",e,!1),t.addEventListener("error",a,!1),t.autoplay=!1,t.src=window.URL.createObjectURL(n)},_loadManifest:function(t){function e(){i._manifest=i._parseManifest(n.data),i._tryStart()}function a(){}var i=this,n={url:t};Dashling.Requests.load(n,!1,e,a)},_parseManifest:function(t){var e,a={},s=new DOMParser,r=s.parseFromString(t,"text/xml");a.baseUrl=i(r,"BaseURL",""),a.mediaDuration=n(r.documentElement.getAttribute("mediaPresentationDuration")),a.streams={};for(var d=[r.querySelector("AdaptationSet[contentType='audio']"),r.querySelector("AdaptationSet[contentType='video']")],l=0;l<d.length;l++){var o=d[l];if(o){for(var u=o.getAttribute("contentType"),h=o.querySelectorAll("Representation"),m=o.querySelector("SegmentTemplate"),g=o.querySelectorAll("S"),_=a.streams[u]={streamType:u,mimeType:o.getAttribute("mimeType"),codecs:o.getAttribute("codecs"),initUrlFormat:m.getAttribute("initialization"),fragUrlFormat:m.getAttribute("media"),qualities:[],timeline:[]},f=m.getAttribute("timescale"),c=0;c<h.length;c++){var p=h[c],y={id:p.getAttribute("id"),bandwidth:p.getAttribute("bandwidth")};p.getAttribute("height")&&(y.width=Number(p.getAttribute("width")),y.height=Number(p.getAttribute("height"))),_.qualities.push(y)}for(var S=0,v=0;v<g.length;v++){var D=g[v],A=Number(D.getAttribute("r"))||0,I=Number(D.getAttribute("d"));for(e=0;A>=e;e++)_.timeline.push({start:S,startSeconds:S/f,length:I,lengthSeconds:I/f}),S+=I}}}return a},_tryStart:function(){var t=this._manifest,e=this._mediaSource;t&&e&&!this._audioStream&&!this._videoStream&&(e.duration=t.mediaDuration,this._audioStream=new Dashling.Stream(e,t,"audio",this.settings),this._videoStream=new Dashling.Stream(e,t,"video",this.settings),this._loadNextFragment())},_loadNextFragment:function(){this._audioStream.loadFragment(this._fragmentIndex,this._tryAppendFragments),this._videoStream.loadFragment(this._fragmentIndex,this._tryAppendFragments)},_assessQuality:function(){var t=this._manifest.mediaDuration-this._videoElement.currentTime;this._audioStream.assessQuality(t,this._fragmentIndex),this._videoStream.assessQuality(t,this._fragmentIndex)},_tryAppendFragments:function(){var t=this._audioStream.getState(this._fragmentIndex),e=this._videoStream.getState(this._fragmentIndex);t==Dashling.FragmentState.downloaded&&e==Dashling.FragmentState.downloaded?(this._audioStream.append(this._fragmentIndex,this._tryAppendFragments),this._videoStream.append(this._fragmentIndex,this._tryAppendFragments)):t==Dashling.FragmentState.appended&&e==Dashling.FragmentState.appended&&(this._fragmentIndex++,this._assessQuality(),this._audioStream.canPlay&&this._videoStream.canPlay&&this._videoElement.play(),this._loadNextFragment())},_tryStartPlaying:function(){},reset:function(){this.manifestLoader.cancelAll(),this.fragmentLoader.cancelAll()}},Dashling.FragmentState={error:"error",idle:"idle",waiting:"waiting",downloading:"downloading",downloaded:"downloaded",appending:"appending",appended:"appended"},Dashling.FragmentStateIndex={error:-1,idle:0,waiting:1,downloading:2,downloaded:3,appending:4,appended:5},Dashling.Stream=function(t,e,a,i){var n=this._streamInfo=e.streams[a],s=(e.mediaDuration,e.fragmentDuration,n.timeline.length);this._settings=i,this._manifest=e,this._mediaSource=t,this._buffer=null,this._streamType=a,this._streamMap=[],this._initSegments=[],this._qualityIndex=Math.max(0,Math.min(n.qualities.length-1,"audio"==a?i.targetAudioQuality:i.targetVideoQuality)),this._latenciesPerQuality={};for(var r=0;s>r;r++)this._streamMap.push({qualityIndex:-1,qualityId:"",time:n.timeline[r],activeRequest:null,requests:[]})},Dashling.Stream.prototype={insertIndex:0,canPlay:!1,getState:function(t){var e=this._streamMap[t],a=e.activeRequest,i=this._streamInfo.qualities.length-1,n=this._initSegments[i],s=a?this._initSegments[a.qualityIndex]:null,r=Dashling.FragmentState.idle,d=a?Dashling.FragmentStateIndex[a.state]:Dashling.FragmentStateIndex.idle,l=s?Dashling.FragmentStateIndex[s.state]:Dashling.FragmentStateIndex.idle,o=n?Dashling.FragmentStateIndex[n.state]:Dashling.FragmentStateIndex.idle,u=Math.min(d,Math.min(o,l));for(var h in Dashling.FragmentStateIndex)if(Dashling.FragmentStateIndex[h]===u){r=h;break}return r},append:function(t,e){function a(){var t=r[0];if(r.length){t.state=Dashling.FragmentState.appending,s.addEventListener("update",i);try{s.appendBuffer(r[0].data)}catch(a){n.state=Dashling.FragmentState.error}}else n.state=Dashling.FragmentState.appended,e()}function i(){var t=r[0];s.removeEventListener("update",i),t.state=Dashling.FragmentState.appended,t.timeAtAppended=(new Date).getTime(),t.clearDataAfterAppend&&(t.data=null),r.shift(),a()}var n=this._streamMap[t],s=this._buffer,r=[],d=n.qualityIndex,l=this._streamInfo.qualities.length-1;s||(s=this._buffer=this._mediaSource.addSourceBuffer(this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs),l>d&&r.push(this._initSegments[l])),n.activeRequest&&n.activeRequest.state==Dashling.FragmentState.downloaded&&((0==t||d!=this._streamMap[t-1].qualityIndex)&&r.push(this._initSegments[d]),r.push(n.activeRequest),a())},loadFragment:function(t,e){function a(){!n._latenciesPerQuality[r.qualityIndex]&&(n._latenciesPerQuality[r.qualityIndex]=[]),n._latenciesPerQuality[r.qualityIndex].push((r.timeAtLastByte-r.timeAtDownloadStarted)/1e3),e()}function i(){}var n=this,s=this._streamMap[t];if(s)if(s.activeRequest&&s.activeRequest.state==Dashling.FragmentState.appended)e();else if(!s.activeRequest){s.qualityIndex=n._qualityIndex,s.qualityId=this._streamInfo.qualities[s.qualityIndex].id,n._loadInitSegment(this._qualityIndex,e);var r={url:n._getUrl(t,s),state:Dashling.FragmentState.downloading,timeAtSesssionStarted:(new Date).getTime(),segmentIndex:t,qualityIndex:s.qualityIndex,qualityId:s.qualityId,retryCount:0,timeAtDownloadStarted:-1,timeAtFirstByte:-1,timeAtLastByte:-1,timeAtAppended:-1,clearDataAfterAppend:!0,data:null,errorCode:null};s.activeRequest=r,s.requests.push(r),Dashling.Requests.load(r,!0,a,i)}},assessQuality:function(t,e){var a=this._settings;if(a.isABREnabled){for(var i=0,n=this._streamInfo.qualities.length-1,s=0,r=!1;n>=i;i++){if(s=this._getTimeToDownloadAtQuality(i,e),s>=t){i=Math.max(0,i-1);break}if(r=!0,i==n)break}this._qualityIndex=i,this.canPlay=r}else this._qualityIndex="audio"==this._streamType?a.targetAudioQuality:a.targetVideoQuality,this.canPlay=this._getTimeToDownloadAtQuality(this._qualityIndex,e)<t},_getTimeToDownloadAtQuality:function(t,e){for(var a=0,i=e;i<this._streamMap.length;i++){var n=this._streamMap[i];n.activeRequest&&n.activeRequest.state==Dashling.appended||(a+=this._getEstimatedDuration(t,e))}return a},_getEstimatedDuration:function(t,e){var i=0,n=this._streamInfo.qualities[t],s=this._latenciesPerQuality[t];if(s&&s.length)i=a(s);else{var r=n.bandwidth/8,d=r*this._streamInfo.timeline[e].lengthSeconds,l=Dashling.Requests.getAverageBytesPerSecond()||1e5;i=d/l}return 1.2*(i+Dashling.Requests.getAverageLatency())},_loadInitSegment:function(t,e){function a(){}var i=this._streamInfo.qualities.length-1;if(t!=i&&this._loadInitSegment(i,e),!this._initSegments[t]){var n=this._initSegments[t]={url:this._getInitUrl(t),state:Dashling.FragmentState.idle,timeAtDownloadStarted:(new Date).getTime(),qualityIndex:t,qualityId:this._streamInfo.qualities[t].id,data:null,errorCode:null};Dashling.Requests.load(n,!0,e,a)}},_getInitUrl:function(t){var e=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[t].id);return this._manifest.baseUrl+e},_getUrl:function(t,e){var a=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",e.qualityId).replace("$Time$",e.time.start);return this._manifest.baseUrl+a}},t(Dashling.Stream.prototype,s),Dashling.Requests={_latencies:[],_bandwidths:[],getAverageLatency:function(){return a(this._latencies)/1e3},getAverageBytesPerSecond:function(){return a(this._bandwidths)},load:function(t,e,a,i){function n(){function o(){++d<r?(t.timeAtFirstByte=-1,t.timeAtLastByte=-1,t.timeAtDownloadStarted=-1,t.retryCount++,setTimeout(n,l[Math.min(l.length-1,d)])):(t.state=Dashling.FragmentState.error,t.errorCode=u.status,i(t))}var u=new XMLHttpRequest;u.open("GET",t.url,!0),e&&(u.responseType="arraybuffer"),u.onreadystatechange=function(){u.readyState>0&&t.timeAtFirstByte<0&&(t.timeAtFirstByte=(new Date).getTime())},u.onprogress=function(){t.timeAtFirstByte<0&&(t.timeAtFirstByte=(new Date).getTime())},u.onload=function(){u.status>=200&&u.status<=299?(t.timeAtLastByte=(new Date).getTime(),t.bytesDownloaded=e?u.response.byteLength:u.responseText.length,t.timeAtFirstByte<0&&(t.timeAtFirstByte=(new Date).getTime()),t.latency=t.timeAtFirstByte-t.timeAtDownloadStarted,t.bandwidth=1e3*t.bytesDownloaded/(t.timeAtLastByte-t.timeAtDownloadStarted),t.bytesDownloaded>5e4&&(s._latencies.push(t.latency),s._bandwidths.push(t.bandwidth)),t.data=e?new Uint8Array(u.response):u.responseText,t.state=Dashling.FragmentState.downloaded,a()):o()},t.state=Dashling.FragmentState.downloading,t.timeAtDownloadStarted=(new Date).getTime(),u.send()}var s=this,r=5,d=-1,l=[200,1500,3e3];t.retryCount=0,n()}}}();