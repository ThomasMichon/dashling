!function(){function e(e){for(var t=0,n=0;e&&n<e.length;n++)t+=e[n];return t/(e.length||1)}function t(e,t,n){var i=e.getElementsByTagName(t)[0],a=i?i.childNodes[0]:null;return a?a.nodeValue:n}function n(e){var t=0,n=e.substring("2"),i=n.indexOf("H");return i>-1&&(t+=60*Number(n.substring(0,i))*60,n=n.substring(i+1)),i=n.indexOf("M"),i>-1&&(t+=60*Number(n.substring(0,i)),n=n.substring(i+1)),i=n.indexOf("S"),i>-1&&(t+=Number(n.substring(0,i))),t}window.mix=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},window.bind=function(e,t){return function(){return t.apply(e,arguments)}},window.EventingMixin={on:function(e,t){this.__events=this.__events||{};var n=this.__events[e]=this.__events[e]||[];n.push(t)},off:function(e,t){var n=this.__events&&this.__events[e];if(n){n.indexOf(t)}},raiseEvent:function(e,t){for(var n=this.__events&&this.__events[e],i=0;n&&i<n.length&&n[i].call(this,t)!==!1;i++);}};var i={sessionStateChange:"sessionstatechange"},a={manifestDownload:"manifestDownload",manifestParse:"manifestParse",mediaSourceInit:"mediaSourceInit",mediaSourceAppend:"mediaSourceAppend",initSegmentDownload:"initSegmentDownload",mediaSegmentDownload:"fragmentDownload",append:"append"},s={error:-1,idle:0,intializing:1,loading:2,playbackInProgress:4,paused:5},r={error:-1,idle:0,downloading:1,downloaded:2,appending:3,appended:4};window.Dashling=function(){this.settings={targetQuality:{audio:5,video:5},isABREnabled:!0,shouldAutoPlay:!0,safeBufferSeconds:15,maxBufferSeconds:180,maxConcurrentRequestsPerStream:4,maxDownloadsBeyondAppendPosition:3,manifest:null}},mix(Dashling,{Event:i,SessionState:s,FragmentState:r,Error:a}),Dashling.prototype={_streamController:null,_sessionIndex:0,_lastError:null,_state:s.idle,load:function(e,t){var n=this;n.reset(),n._setState(Dashling.intializing),n._videoElement=e,n._initializeMediaSource(e),n._initializeManifest(t)},reset:function(){var e=this;if(e._streamController&&(e._streamController.dispose(),e._streamController=null),e._parser&&(e._parser.dispose(),e._parser=null),e._videoElement){try{e._videoElement.stop(),e._videoElement.src=""}catch(t){}e._videoElement=null}e.videoElement=null,e.settings.manifest=null,e._mediaSource=null,e._setState(s.idle)},getPlayingQuality:function(e){return this._streamController?this._streamController.getPlayingQuality(e):this.settings[e]},getBufferingQuality:function(e){return this._streamController?this._streamController.getBufferingQuality(e):this.settings[e]},_setState:function(e,t){this._state!=e&&(this._state=e,this._lastError=t,this.raiseEvent(i.sessionStateChange,{state:e,error:t}))},_initializeMediaSource:function(e){function t(){n.removeEventListener("sourceopen",t),a._sessionIndex==r&&(a._mediaSource=n,a._tryStart())}var n,a=this,r=a._sessionIndex;a.raiseEvent(i.initMediaSourceStart);try{n=new MediaSource}catch(o){a._setState(s.error,DashlingSessionError.mediaSourceInit)}n.addEventListener("sourceopen",t,!1),e.autoplay=!1,e.src=window.URL.createObjectURL(n)},_initializeManifest:function(e){function t(e){i._loadIndex==a&&i.state!=s.error&&(i.settings.manifest=e,i._tryStart())}function n(){i._loadIndex==_loadIndex&&i._setState(s.error,DashlingSessionError.manifestFailed)}var i=this,a=i._loadIndex;i.settings.manifest?t(i.settings.manifest):(this._parser=new Dashling.ManifestParser,this._parser.parse(e,t,n))},_tryStart:function(){var e=this;e._state!=s.error&&e._mediaSource&&e.settings.manifest&&(e._setState(s.loading),e._mediaSource.duration=e.settings.manifest.mediaDuration,e._streamController=new Dashling.StreamController(e._videoElement,e._mediaSource,e.settings))}},mix(Dashling.prototype,EventingMixin),Dashling.ManifestParser=function(){this._requestManager=new Dashling.RequestManager},Dashling.ManifestParser.prototype={_parseIndex:0,dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},parse:function(e,t,n){function i(){s._parseIndex==r&&t(s._parseManifest(o.data))}function a(){s._parseIndex==r&&n(o)}var s=this,r=++s._parseIndex,o={url:e};this._requestManager.load(o,!1,i,a)},_parseManifest:function(e){var i,a={},s=new DOMParser,r=s.parseFromString(e,"text/xml");a.baseUrl=t(r,"BaseURL",""),a.mediaDuration=n(r.documentElement.getAttribute("mediaPresentationDuration")),a.streams={};for(var o=[r.querySelector("AdaptationSet[contentType='audio']"),r.querySelector("AdaptationSet[contentType='video']")],d=0;d<o.length;d++){var l=o[d];if(l){for(var u=l.getAttribute("contentType"),m=l.querySelectorAll("Representation"),g=l.querySelector("SegmentTemplate"),_=l.querySelectorAll("S"),f=a.streams[u]={streamType:u,mimeType:l.getAttribute("mimeType"),codecs:l.getAttribute("codecs"),initUrlFormat:g.getAttribute("initialization"),fragUrlFormat:g.getAttribute("media"),qualities:[],timeline:[]},h=g.getAttribute("timescale"),p=0;p<m.length;p++){var c=m[p],y={id:c.getAttribute("id"),bandwidth:c.getAttribute("bandwidth")};c.getAttribute("height")&&(y.width=Number(c.getAttribute("width")),y.height=Number(c.getAttribute("height"))),f.qualities.push(y)}for(var v=0,x=0;x<_.length;x++){var I=_[x],S=Number(I.getAttribute("r"))||0,q=Number(I.getAttribute("d"));for(i=0;S>=i;i++)f.timeline.push({start:v,startSeconds:v/h,length:q,lengthSeconds:q/h}),v+=q}}}return a}},Dashling.StreamController=function(e,t,n){var i=this;i._onVideoSeeking=bind(i,i._onVideoSeeking),i._appendNextFragment=bind(i,i._appendNextFragment),i._videoElement=e,i._videoElement.addEventListener("seeking",i._onVideoSeeking),i._mediaSource=t,i._settings=n,i._streams=[i._audioStream=new Dashling.Stream("audio",t,n),i._videoStream=new Dashling.Stream("video",t,n)],i._loadNextFragment()},Dashling.StreamController.prototype={_nextStreamIndex:0,_appendIndex:0,_audioDownloadIndex:0,_videoDownloadIndex:0,_simultaneousDownloadsPerStream:2,_maxSegmentsAhead:2,dispose:function(){var e=this;e._videoElement&&(e._videoElement.removeEventListener("seeking",e._onVideoSeeking),e._videoElement=null),e._mediaSource=null,e._audioStream=null,e._videoStream=null},getPlayingQuality:function(){},getBufferingQuality:function(){},_loadNextFragment:function(){for(var e=this,t=e._getDownloadList(),n=0;n<t.length;n++){var i=t[n],a=e._streams[i.streamIndex],s=(a.fragments[i.fragmentIndex],a.fragments[i.fragmentIndex-1]),o=s&&s.activeRequest&&s.activeRequest.state==r.downloading?s.activeRequest:null,d=(new Date).getTime(),l=a._getMinDelayBetweenRequests(a.qualityIndex),u=o?d-o.startTime:0;!o&&this._appendIndex==i.fragmentIndex||u>l?a.load(i.fragmentIndex,this._appendNextFragment):e._timerId||(e._timerId=setTimeout(function(){e._timerId=0,e._loadNextFragment()},l-u))}},_appendNextFragment:function(){var e,t=this,n=this._streams;if(n&&n.length){for(;t._appendIndex<n[0].fragments.length;){var i=!0,a=!0;for(e=0;e<n.length;e++){var s=n[e];i&=s.canAppend(t._appendIndex),a&=s.fragments[t._appendIndex].state==r.appended}if(i)for(a=!1,e=0;e<n.length;e++){var s=n[e];s.append(t._appendIndex,t._appendNextFragment),a&=s.fragments[t._appendIndex].state==r.appended}if(!a)break;t._appendIndex++}t._loadNextFragment()}},_getDownloadList:function(){for(var e=[],t=this._nextStreamIndex,n=this._appendIndex,i=Math.min(this._appendIndex+this._settings.maxDownloadsBeyondAppendPosition,this._streams[0].fragments.length-1),t=((new Date).getTime(),0);t<this._streams.length;t++)for(var a=this._streams[t],s=a._getMaxConcurrentRequests(a.qualityIndex),o=0,n=this._appendIndex;i>=n&&s>o;n++){var d=a.fragments[n];d.state==r.downloading?o++:d.state==r.idle&&(e.push({streamIndex:t,fragmentIndex:n}),o++)}return e},_isFragmentDownloadable:function(e){return e.state==r.idle},_onVideoSeeking:function(){}},Dashling.Stream=function(e,t,n){var i=this,a=n.manifest.streams[e];mix(i,{fragments:[],qualityIndex:Math.max(0,Math.min(a.qualities.length-1,n.targetQuality[e])),_initializedQualityIndex:-1,_requestManager:new Dashling.RequestManager,_streamType:e,_mediaSource:t,_settings:n,_manifest:n.manifest,_streamInfo:a,_buffer:null,_initSegments:[],_delaysPerQuality:{},_maxConcurrentRequestsPerQuality:{}});for(var s=a.timeline.length,o=0;s>o;o++)i.fragments.push({state:r.idle,qualityIndex:-1,qualityId:"",time:a.timeline[o],activeRequest:null,requests:[]})},Dashling.Stream.prototype={canAppend:function(e){var t=this.fragments[e],n=t?this._initSegments[t.qualityIndex]:null,i=this._initSegments[this._streamInfo.qualities.length-1];return t&&t.state==r.downloaded&&n&&n.state==r.downloaded&&i&&i.state==r.downloaded},append:function(e,t){function n(){var e=d[0];if(d.length){l.addEventListener("update",i);try{console.log("Append started: "+a._streamType+" "+e.qualityId+" "+e.fragmentType+" "+(void 0!==e.segmentIndex?"index "+e.segmentIndex:"")),l.appendBuffer(e.data)}catch(n){s.state=r.error,a._isAppending=!1}}else s.state=r.appended,a._isAppending=!1,t()}function i(){var e=d[0];l.removeEventListener("update",i),e.timeAtAppended=(new Date).getTime()-e.startTime,e.clearDataAfterAppend&&(e.data=null),"init"===e.fragmentType&&(a._initializedQualityIndex=e.qualityIndex),console.log("Append complete: "+a._streamType+" "+e.qualityId+" "+e.fragmentType+" "+(void 0!==e.segmentIndex?"index "+e.segmentIndex:"")),d.shift(),n()}var a=this,s=a.fragments[e],o=a._streamInfo.qualities.length-1,d=[],l=a._buffer;!a._isAppending&&s&&s.state===r.downloaded&&(a._isAppending=!0,s.state=r.appending,l||(l=a._getSourceBuffer(),o>s.qualityIndex&&d.push(a._initSegments[o])),a._initializedQualityIndex!=s.qualityIndex&&d.push(a._initSegments[s.qualityIndex]),d.push(s.activeRequest),n())},load:function(e,t){function n(e){s.state=r.downloaded;var n=Math.round(e.timeAtLastByte-(e.timeAtEstimatedFirstByte||e.timeAtFirstByte)),i=e.timeAtLastByte-n,o=Math.max(1,Math.min(a._settings.maxConcurrentRequestsPerStream,Math.ceil(i/n))),d=o>1?Math.max(i/o,n):0;console.log("Download complete: "+a._streamType+" "+e.qualityId+" "+e.fragmentType+"index "+e.segmentIndex+" timeDownloading: "+n+" timeWaiting:"+i+" newDelay: "+d+" maxReq: "+o),a._maxConcurrentRequestsPerQuality[e.qualityIndex]=o,a._delaysPerQuality[e.qualityIndex]=d,t(s)}function i(){}var a=this,s=this.fragments[e];if(s&&s.state==r.idle&&!s.activeRequest){s.state=r.downloading,s.qualityIndex=a.qualityIndex,s.qualityId=this._streamInfo.qualities[s.qualityIndex].id,a._loadInitSegment(this.qualityIndex,t);var o={url:a._getUrl(e,s),state:r.downloading,segmentIndex:e,fragmentType:"media",qualityIndex:s.qualityIndex,qualityId:s.qualityId,clearDataAfterAppend:!0};s.activeRequest=o,s.requests.push(o),console.log("Download started: "+a._streamType+" "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.segmentIndex?"index "+o.segmentIndex:"")),a._requestManager.load(o,!0,n,i)}},assessQuality:function(e,t){var n=this._settings;if(n.isABREnabled){for(var i=0,a=this._streamInfo.qualities.length-1,s=0,r=!1;a>=i;i++){if(s=this._getTimeToDownloadAtQuality(i,t),s>=e){i=Math.max(0,i-1);break}if(r=!0,i==a)break}this.qualityIndex=i,this.canPlay=r}else this.qualityIndex="audio"==this._streamType?n.targetAudioQuality:n.targetVideoQuality,this.canPlay=this._getTimeToDownloadAtQuality(this.qualityIndex,t)<e},_getSourceBuffer:function(){return this._buffer||(this._buffer=this._mediaSource.addSourceBuffer(this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs)),this._buffer},_getTimeToDownloadAtQuality:function(e,t){for(var n=0,i=t;i<this.fragments.length;i++){var a=this.fragments[i];a.activeRequest&&a.activeRequest.state==Dashling.appended||(n+=this._getEstimatedDuration(e,t))}return n},_getMaxConcurrentRequests:function(e){return this._maxConcurrentRequestsPerQuality[e]||1},_getMinDelayBetweenRequests:function(e){return this._delaysPerQuality[e]||1e3},_getEstimatedDuration:function(t,n){var i=0,a=this._streamInfo.qualities[t],s=this._latenciesPerQuality[t];if(s&&s.length)i=e(s);else{var r=a.bandwidth/8,o=r*this._streamInfo.timeline[n].lengthSeconds,d=Dashling.Requests.getAverageBytesPerSecond()||1e5;i=o/d}return 1.2*(i+Dashling.Requests.getAverageLatency())},_loadInitSegment:function(e,t){function n(){o.state=r.downloaded,console.log("Download complete: "+a._streamType+" "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.segmentIndex?"index "+o.segmentIndex:"")),t(o)}function i(){o.state=r.error}var a=this,s=this._streamInfo.qualities.length-1;if(e!=s&&a._loadInitSegment(s,t),!a._initSegments[e]){var o=a._initSegments[e]={url:this._getInitUrl(e),state:r.downloading,timeAtDownloadStarted:(new Date).getTime(),fragmentType:"init",qualityIndex:e,qualityId:this._streamInfo.qualities[e].id};console.log("Download started: "+a._streamType+" "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.segmentIndex?"index "+o.segmentIndex:"")),a._requestManager.load(o,!0,n,i)}},_getInitUrl:function(e){var t=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[e].id);return this._manifest.baseUrl+t},_getUrl:function(e,t){var n=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",t.qualityId).replace("$Time$",t.time.start);return this._manifest.baseUrl+n}},mix(Dashling.Stream.prototype,EventingMixin),Dashling.RequestManager=function(){this._activeRequests={},this._latencies=[],this._bandwidths=[]},Dashling.RequestManager.prototype={maxRetries:3,delayBetweenRetries:[200,1500,3e3],_requestIndex:0,_xhrType:XMLHttpRequest,dispose:function(){for(var e in this._activeRequests)this._activeRequests[e].abort();this._activeRequests={}},load:function(e,t,n,i){function a(){function u(){++d<o?(e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.retryCount++,setTimeout(a,l[Math.min(l.length-1,d)])):(e.state=r.error,e.statusCode=m.status,i&&i(e))}var m=new s._xhrType,g=++s._requestIndex;s._activeRequests[g]=m,m.open("GET",e.url,!0),t&&(m.responseType="arraybuffer"),m.onreadystatechange=function(){m.readyState>0&&e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime)},m.onprogress=function(t){e.progressEvents.push({timeFromStart:(new Date).getTime()-e.startTime,bytesLoaded:t.lengthComputable?t.loaded:-1})},m.onloadend=function(){if(delete s._activeRequests[g],m.status>=200&&m.status<=299){if(e.timeAtLastByte=(new Date).getTime()-e.startTime,e.bytesLoaded=t?m.response.byteLength:m.responseText.length,e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime),e.progressEvents.length>1){var i=e.progressEvents[e.progressEvents.length-1],a=e.progressEvents[0],o=i.timeFromStart-a.timeFromStart,d=i.bytesLoaded-a.bytesLoaded,l=d/o;e.timeAtEstimatedFirstByte=e.timeAtLastByte-e.bytesLoaded/l,d>1e4&&o>5&&s._bandwidths.push(l)}e.data=t?new Uint8Array(m.response):m.responseText,e.statusCode=m.status,e.state=r.downloaded,n&&n(e)}else u(e)},e.state=r.downloading,e.progressEvents=[],e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.startTime=(new Date).getTime(),m.send()}var s=this,o=this.maxRetries,d=-1,l=this.delayBetweenRetries;e.retryCount=0,a()},getAverageLatency:function(){return e(this._latencies)/1e3},getAverageBandwidth:function(){return e(this._bandwidths)}}}();