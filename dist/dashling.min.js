!function(){function e(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function t(e,t){return function(){return t.apply(e,arguments)}}function n(e,t){t=Math.max(0,t||0);var n=0,a=e?e.length-t:0;if(a){for(t;t<e.length;t++)n+=e[t];n/=a}return n}function a(e,t){(!t||t.logToConsole)&&console.log(e)}function i(e,t,n){var a=e.getElementsByTagName(t)[0],i=a?a.childNodes[0]:null;return i?i.nodeValue:n}function s(e){var t=0,n=e.substring("2"),a=n.indexOf("H");return a>-1&&(t+=60*Number(n.substring(0,a))*60,n=n.substring(a+1)),a=n.indexOf("M"),a>-1&&(t+=60*Number(n.substring(0,a)),n=n.substring(a+1)),a=n.indexOf("S"),a>-1&&(t+=Number(n.substring(0,a))),t}var r={on:function(e,t){this.__events=this.__events||{};var n=this.__events[e]=this.__events[e]||[];n.push(t)},off:function(e,t){var n=this.__events&&this.__events[e];if(n){n.indexOf(t)}},raiseEvent:function(e,t){for(var n=this.__events&&this.__events[e],a=0;n&&a<n.length&&n[a].call(this,t)!==!1;a++);}},o={sessionStateChange:"sessionstatechange"},d={manifestDownload:"manifestDownload",manifestParse:"manifestParse",mediaSourceInit:"mediaSourceInit",mediaSourceAppend:"mediaSourceAppend",initSegmentDownload:"initSegmentDownload",mediaSegmentDownload:"fragmentDownload",append:"append"},l={error:-1,idle:0,intializing:1,loading:2,playbackInProgress:4,paused:5},u={error:-1,idle:0,downloading:1,downloaded:2,appending:3,appended:4};window.Dashling=function(){this.settings={targetQuality:{audio:5,video:5},isABREnabled:!0,shouldAutoPlay:!0,safeBufferSeconds:15,maxBufferSeconds:180,logToConsole:!0,maxConcurrentRequestsPerStream:4,maxDownloadsBeyondAppendPosition:3,manifest:null}},e(Dashling,{Event:o,SessionState:l,FragmentState:u,Error:d}),Dashling.prototype={_streamController:null,_sessionIndex:0,_lastError:null,_state:l.idle,load:function(e,t){var n=this;n.reset(),n._setState(Dashling.intializing),n._videoElement=e,n._initializeMediaSource(e),n._initializeManifest(t)},dispose:function(){this.reset()},reset:function(){var e=this;if(e._streamController&&(e._streamController.dispose(),e._streamController=null),e._parser&&(e._parser.dispose(),e._parser=null),e._videoElement){try{e._videoElement.pause()}catch(t){}e._videoElement=null}e.videoElement=null,e.settings.manifest=null,e._mediaSource=null,e._setState(l.idle)},getPlayingQuality:function(e){return this._streamController?this._streamController.getPlayingQuality(e):this.settings[e]},getBufferingQuality:function(e){return this._streamController?this._streamController.getBufferingQuality(e):this.settings[e]},getMaxQuality:function(e){return this.settings.manifest?this.settings.manifest.streams[e].qualities.length-1:0},_setState:function(e,t){this._state!=e&&(this._state=e,this._lastError=t,this.raiseEvent(o.sessionStateChange,{state:e,error:t}))},_initializeMediaSource:function(e){function t(){n.removeEventListener("sourceopen",t),a._sessionIndex==i&&(a._mediaSource=n,a._tryStart())}var n,a=this,i=a._sessionIndex;a.raiseEvent(o.initMediaSourceStart);try{n=new MediaSource}catch(s){a._setState(l.error,DashlingSessionError.mediaSourceInit)}n.addEventListener("sourceopen",t,!1),e.autoplay=!1,e.src=window.URL.createObjectURL(n)},_initializeManifest:function(e){function t(e){a._loadIndex==i&&a.state!=l.error&&(a.settings.manifest=e,a._tryStart())}function n(){a._loadIndex==_loadIndex&&a._setState(l.error,DashlingSessionError.manifestFailed)}var a=this,i=a._loadIndex;a.settings.manifest?t(a.settings.manifest):(this._parser=new Dashling.ManifestParser,this._parser.parse(e,t,n))},_tryStart:function(){var e=this;e._state!=l.error&&e._mediaSource&&e.settings.manifest&&(e._setState(l.loading),e._mediaSource.duration=e.settings.manifest.mediaDuration,e._streamController=new Dashling.StreamController(e._videoElement,e._mediaSource,e.settings))}},e(Dashling.prototype,r),Dashling.ManifestParser=function(){this._requestManager=new Dashling.RequestManager},Dashling.ManifestParser.prototype={_parseIndex:0,dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},parse:function(e,t,n){function a(){s._parseIndex==r&&t(s._parseManifest(o.data))}function i(){s._parseIndex==r&&n(o)}var s=this,r=++s._parseIndex,o={url:e};this._requestManager.load(o,!1,a,i)},_parseManifest:function(e){var t,n={},a=new DOMParser,r=a.parseFromString(e,"text/xml");n.baseUrl=i(r,"BaseURL",""),n.mediaDuration=s(r.documentElement.getAttribute("mediaPresentationDuration")),n.streams={};for(var o=[r.querySelector("AdaptationSet[contentType='audio']"),r.querySelector("AdaptationSet[contentType='video']")],d=0;d<o.length;d++){var l=o[d];if(l){for(var u=l.getAttribute("contentType"),m=l.querySelectorAll("Representation"),g=l.querySelector("SegmentTemplate"),_=l.querySelectorAll("S"),h=n.streams[u]={streamType:u,mimeType:l.getAttribute("mimeType"),codecs:l.getAttribute("codecs"),initUrlFormat:g.getAttribute("initialization"),fragUrlFormat:g.getAttribute("media"),qualities:[],timeline:[]},f=g.getAttribute("timescale"),p=0;p<m.length;p++){var c=m[p],y={id:c.getAttribute("id"),bandwidth:c.getAttribute("bandwidth")};c.getAttribute("height")&&(y.width=Number(c.getAttribute("width")),y.height=Number(c.getAttribute("height"))),h.qualities.push(y)}for(var v=0,I=0;I<_.length;I++){var x=_[I],q=Number(x.getAttribute("r"))||0,S=Number(x.getAttribute("d"));for(t=0;q>=t;t++)h.timeline.push({start:v,startSeconds:v/f,length:S,lengthSeconds:S/f}),v+=S}}}return n}},Dashling.StreamController=function(e,n,a){var i=this;i._onVideoSeeking=t(i,i._onVideoSeeking),i._appendNextFragment=t(i,i._appendNextFragment),i._onThrottledSeek=t(i,i._onThrottledSeek),i._videoElement=e,i._videoElement.addEventListener("seeking",i._onVideoSeeking),i._mediaSource=n,i._settings=a,i._streams=[i._audioStream=new Dashling.Stream("audio",n,e,a),i._videoStream=new Dashling.Stream("video",n,e,a)],i._loadNextFragment()},Dashling.StreamController.prototype={_nextStreamIndex:0,_appendIndex:0,_audioDownloadIndex:0,_videoDownloadIndex:0,_simultaneousDownloadsPerStream:2,_maxSegmentsAhead:2,_nextRequestTimerId:0,_seekingTimerId:0,dispose:function(){var e=this;e._videoElement&&(e._videoElement.removeEventListener("seeking",e._onVideoSeeking),e._videoElement=null);for(var t=0;e._streams&&t<e._streams.length;t++)e._streams[t].dispose();e._nextRequestTimerId&&(clearTimeout(e._nextRequestTimerId),e._nextRequestTimerId=0),e._seekingTimerId&&(clearTimeout(e._seekingTimerId),e._seekingTimerId=0),e._streams=null,e._mediaSource=null},getPlayingQuality:function(e){var t=this._videoElement.currentTime,n="video"==e?this._videoStream:e._audioStream,a=Math.floor(t/n.fragments[0].time.lengthSeconds),i=n.fragments[a].qualityIndex;return i>=0?i:n.qualityIndex},getBufferingQuality:function(e){var t="video"==e?this._videoStream:this._audioStream;return t.qualityIndex},_loadNextFragment:function(){for(var e=this,t=e._getDownloadList(),n=0;n<t.length;n++){var a=t[n],i=e._streams[a.streamIndex],s=(i.fragments[a.fragmentIndex],i.fragments[a.fragmentIndex-1]),r=s&&s.activeRequest&&s.activeRequest.state==u.downloading?s.activeRequest:null,o=(new Date).getTime(),d=i._getMinDelayBetweenRequests(i.qualityIndex),l=r?o-r.startTime:0;!r&&this._appendIndex==a.fragmentIndex||l>d?i.load(a.fragmentIndex,this._appendNextFragment):e._nextRequestTimerId||(e._nextRequestTimerId=setTimeout(function(){e._nextRequestTimerId=0,e._loadNextFragment()},d-l))}},_appendNextFragment:function(){var e,t,n=this,a=this._streams;if(a&&a.length){for(;n._appendIndex<a[0].fragments.length;){var i=!0,s=!0;for(t=0;t<a.length;t++)e=a[t],i&=e.canAppend(n._appendIndex),s&=e.fragments[n._appendIndex].state==u.appended;if(i)for(s=!1,t=0;t<a.length;t++){var e=a[t];e.append(n._appendIndex,n._appendNextFragment),s&=e.fragments[n._appendIndex].state==u.appended}if(!s)break;var r=!0;n._appendIndex++,r&&this._settings.shouldAutoPlay&&!this._hasAutoPlayed&&(this._hasAutoPlayed=!0,this._videoElement.play())}n._loadNextFragment()}},_getDownloadList:function(){{var e,t=this,n=[],a=t._streams,i=t._settings,s=Math.min(this._appendIndex+i.maxDownloadsBeyondAppendPosition,a[0].fragments.length-1);i.manifest.mediaDuration-t._videoElement.currentTime}for(e=0;e<a.length;e++)for(var r=a[e],o=r._getMaxConcurrentRequests(r.qualityIndex),d=0,l=t._appendIndex;s>=l&&o>d;l++){var m=r.fragments[l];m.state==u.downloading?d++:r.canLoad(l)&&(n.push({streamIndex:e,fragmentIndex:l}),d++)}return n},_onVideoSeeking:function(){this._seekingTimerId||(this._seekingTimerId=setTimeout(this._onThrottledSeek,500))},_onThrottledSeek:function(){var e=this,t=e._videoElement.currentTime,n=Math.floor(t/e._streams[0].fragments[0].time.lengthSeconds);if(e._seekingTimerId=0,a("Throttled seek: "+e._videoElement.currentTime,e._settings),e._nextRequestTimerId&&(clearTimeout(e._nextRequestTimerId),e._nextRequestTimerId=0),e._appendIndex<n)for(var i=0;i<e._streams.length;i++)e._streams[i].abortAll();e._appendIndex=n,e._appendNextFragment()}},Dashling.Stream=function(t,n,a,i){var s=this,r=i.manifest.streams[t];e(s,{fragments:[],qualityIndex:Math.max(0,Math.min(r.qualities.length-1,i.targetQuality[t])),_initializedQualityIndex:-1,_initRequestManager:new Dashling.RequestManager,_requestManager:new Dashling.RequestManager,_streamType:t,_mediaSource:n,_videoElement:a,_settings:i,_manifest:i.manifest,_streamInfo:r,_buffer:null,_initSegments:[],_delaysPerQuality:{},_maxConcurrentRequestsPerQuality:{},_latenciesPerQuality:{}});for(var o=r.timeline.length,d=0;o>d;d++)s.fragments.push({state:u.idle,qualityIndex:-1,qualityId:"",fragmentType:"media",fragmentIndex:d,time:r.timeline[d],activeRequest:null,requests:[]})},Dashling.Stream.prototype={dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},abortAll:function(){this._requestManager.abortAll()},canAppend:function(e){var t=this.fragments[e],n=t?this._initSegments[t.qualityIndex]:null,a=this._initSegments[this._streamInfo.qualities.length-1];return t&&t.state==u.downloaded&&n&&n.state>=u.downloaded&&a&&a.state>=u.downloaded},append:function(e,t){function n(){var e=d[0];if(d.length){l.addEventListener("update",i);try{a("Append started: "+s._streamType+" "+e.qualityId+" "+e.fragmentType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),s._settings),l.appendBuffer(e.data)}catch(n){e.state=r.state=u.error,s._isAppending=!1,t()}}else r.state=u.appended,s._isAppending=!1,t(r)}function i(){var e=d[0];l.removeEventListener("update",i),e.timeAtAppended=(new Date).getTime()-e.startTime,e.state=u.appended,e.clearDataAfterAppend&&(e.data=null),"init"===e.fragmentType&&(s._initializedQualityIndex=e.qualityIndex),a("Append complete: "+s._streamType+" "+e.qualityId+" "+e.fragmentType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),s._settings),d.shift(),n()}var s=this,r=s.fragments[e],o=s._streamInfo.qualities.length-1,d=[],l=s._buffer;!s._isAppending&&r&&r.state===u.downloaded&&(s._isAppending=!0,r.state=u.appending,l||(l=s._getSourceBuffer(),o>r.qualityIndex&&d.push(s._initSegments[o])),d.push(s._initSegments[r.qualityIndex]),d.push(r.activeRequest),n())},canLoad:function(e){var t=!1,n=this.fragments[e];if(n){if(n.state==u.appended){for(var a=this._buffer.buffered,i=n.time,s=.05,r=!1,o=0;o<a.length;o++)if(a.start(o)-s<=i.startSeconds&&a.end(o)+s>=i.startSeconds+i.lengthSeconds){r=!0;break}r||(n.state=u.idle)}t=n.state<=u.idle}return t},load:function(e,t){function n(e){r.state=u.downloaded;var n=Math.round(e.timeAtLastByte-(e.timeAtEstimatedFirstByte||e.timeAtFirstByte)),i=e.timeAtLastByte-n,o=Math.max(2,Math.min(s._settings.maxConcurrentRequestsPerStream,Math.round(i/n))),d=o>1?Math.round(Math.max(i/o,n)):0;a("Download complete: "+e.qualityId+" "+e.fragmentType+" index: "+e.fragmentIndex+" waiting: "+i+"ms receiving: "+n+"ms nextDelay: "+d+" maxReq: "+o,s._settings),s._maxConcurrentRequestsPerQuality[e.qualityIndex]=o,s._delaysPerQuality[e.qualityIndex]=d,t(r)}function i(){"aborted"!=r.state?r.state=u.error:(r.state=u.idle,r.activeRequest=null,r.requests=[])}var s=this,r=this.fragments[e];if(this.assessQuality2(e),r&&r.state<=u.idle){r.state=u.downloading,r.qualityIndex=s.qualityIndex,r.qualityId=this._streamInfo.qualities[r.qualityIndex].id,s._loadInitSegment(this.qualityIndex,t);var o={url:s._getUrl(e,r),state:u.downloading,fragmentIndex:e,fragmentType:"media",qualityIndex:r.qualityIndex,qualityId:r.qualityId,clearDataAfterAppend:!0};r.activeRequest=o,r.requests.push(o),a("Download started: "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),s._settings),s._requestManager.load(o,!0,n,i)}},assessQuality2:function(){var e=this,t=e._settings,n=e._requestManager.getAverageBandwidth(),i=this._streamInfo.qualities.length-1;if(t.isABREnabled&&n){for(var s=0,r="Assess "+this._streamType+": bps="+Math.round(1e3*n),o=this._streamInfo.timeline[0].lengthSeconds,d=.5*o,l=0;i>=l;l++){var u=0,m=this._streamInfo.qualities[l],g=m.bandwidth/8,_=g*o,h=1e3*n||1e5;u=_/h,r+=" "+l+"="+Math.round(u)+"s",o>u+d&&(s=l)}a(r,e.settings),e.qualityIndex=s}else e.qualityIndex=Math.min(this._streamInfo.qualities.length-1,t.targetQuality[e._streamType])},assessQuality:function(e,t){var n=this,i=n._settings,s=n._requestManager.getAverageBandwidth();if(i.isABREnabled&&s){for(var r=0,o=n._streamInfo.qualities.length-1,d=0,l=!1,u="Assess "+this._streamType+": remaining="+Math.round(e)+"s";o>=r;r++){if(d=n._getTimeToDownloadAtQuality(r,t),u+=" "+r+"="+Math.round(d)+"s ",d>=e){r=Math.max(0,r-1);break}if(l=!0,r==o)break}a(u,n.settings),this.qualityIndex!=r&&a("Quality change: "+n._streamType+" from "+n.qualityIndex+" to "+r,n.settings),n.qualityIndex=r,n.canPlay=l}else n.qualityIndex=Math.min(this._streamInfo.qualities.length-1,i.targetQuality[n._streamType]),n.canPlay=n._getTimeToDownloadAtQuality(n.qualityIndex,t)<e},_getSourceBuffer:function(){return this._buffer||(this._buffer=this._mediaSource.addSourceBuffer(this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs)),this._buffer},_getTimeToDownloadAtQuality:function(e,t){for(var n=0,a=t;a<this.fragments.length;a++){var i=this.fragments[a];!i.state<u.downloaded&&(n+=this._getEstimatedDuration(e,t))}return n},_getMaxConcurrentRequests:function(e){return this._maxConcurrentRequestsPerQuality[e]||1},_getMinDelayBetweenRequests:function(e){return this._delaysPerQuality[e]||1e3},_getEstimatedDuration:function(e,t){var n=0,a=this._streamInfo.qualities[e],i=a.bandwidth/8,s=i*this._streamInfo.timeline[t].lengthSeconds,r=1e3*this._requestManager.getAverageBandwidth()||1e5;return n=s/r,n+this._requestManager.getAverageLatency()/1e3},_loadInitSegment:function(e,t){function n(){o.state=u.downloaded,a("Download complete: "+s._streamType+" "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),s._settings),t(o)}function i(){o.state=u.error}var s=this,r=this._streamInfo.qualities.length-1;if(e!=r&&s._loadInitSegment(r,t),!s._initSegments[e]){var o=s._initSegments[e]={url:this._getInitUrl(e),state:u.downloading,timeAtDownloadStarted:(new Date).getTime(),fragmentType:"init",qualityIndex:e,qualityId:this._streamInfo.qualities[e].id};a("Download started: "+s._streamType+" "+o.qualityId+" "+o.fragmentType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),s._settings),s._initRequestManager.load(o,!0,n,i)}},_getInitUrl:function(e){var t=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[e].id);return this._manifest.baseUrl+t},_getUrl:function(e,t){var n=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",t.qualityId).replace("$Time$",t.time.start);return this._manifest.baseUrl+n}},e(Dashling.Stream.prototype,r),Dashling.RequestManager=function(){this._activeRequests={},this._latencies=[],this._bandwidths=[]};var m={noPendingRequests:0,waitingForResponse:1,receivingData:2,receivingParallelData:3};Dashling.RequestManager.prototype={maxRetries:3,delayBetweenRetries:[200,1500,3e3],_requestIndex:0,_state:m.noPendingRequests,_xhrType:XMLHttpRequest,dispose:function(){this.abortAll()},abortAll:function(){for(var e in this._activeRequests){var t=this._activeRequests[e];a("Aborting request: "+t.url),t.isAborted=!0,t.abort()}this._activeRequests={}},load:function(e,t,n,a){function i(){function l(){!m.isAborted&&++o<r?(e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.retryCount++,setTimeout(i,d[Math.min(d.length-1,o)])):(e.state=u.error,e.statusCode=m.isAborted?"aborted":m.status,a&&a(e))}var m=new s._xhrType,g=++s._requestIndex;s._activeRequests[g]=m,m.url=e.url,m.open("GET",e.url,!0),t&&(m.responseType="arraybuffer"),m.onreadystatechange=function(){m.readyState>0&&e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime)},m.onprogress=function(t){e.progressEvents.push({timeFromStart:(new Date).getTime()-e.startTime,bytesLoaded:t.lengthComputable?t.loaded:-1})},m.onloadend=function(){if(delete s._activeRequests[g],m.status>=200&&m.status<=299){if(e.timeAtLastByte=(new Date).getTime()-e.startTime,e.bytesLoaded=t?m.response.byteLength:m.responseText.length,m.onreadystatechange(),e.progressEvents.length>1){var a=e.progressEvents[e.progressEvents.length-1],i=e.progressEvents[0],r=a.timeFromStart-i.timeFromStart,o=a.bytesLoaded-i.bytesLoaded;e.bytesPerMillisecond=o/r,e.timeAtEstimatedFirstByte=e.timeAtLastByte-e.bytesLoaded/e.bytesPerMillisecond,o>1e4&&(s._bandwidths.push(e.bytesPerMillisecond),s._latencies.push(e.timeAtEstimatedFirstByte))}e.data=t?new Uint8Array(m.response):m.responseText,e.statusCode=m.status,e.state=u.downloaded,n&&n(e)}else l(e)},e.state=u.downloading,e.progressEvents=[],e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.startTime=(new Date).getTime(),m.send()}var s=this,r=this.maxRetries,o=-1,d=this.delayBetweenRetries;e.retryCount=0,i()},getAverageLatency:function(){return n(this._latencies,this._bandwidths.length-5)},getAverageBandwidth:function(){return n(this._bandwidths,this._bandwidths.length-5)}}}();