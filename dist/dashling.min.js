!function(){function e(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function t(e,t){return function(){return t.apply(e,arguments)}}function n(e,t){t=Math.max(0,t||0);var n=0,i=e?e.length-t:0;if(i){for(t;t<e.length;t++)n+=e[t];n/=i}return n}function i(e,t){(!t||t.logToConsole)&&console.log(e)}function a(e,t,n){var i=e.getElementsByTagName(t)[0],a=i?i.childNodes[0]:null;return a?a.nodeValue:n}function s(e){var t=0,n=e.substring("2"),i=n.indexOf("H");return i>-1&&(t+=60*Number(n.substring(0,i))*60,n=n.substring(i+1)),i=n.indexOf("M"),i>-1&&(t+=60*Number(n.substring(0,i)),n=n.substring(i+1)),i=n.indexOf("S"),i>-1&&(t+=Number(n.substring(0,i))),t}function r(e){var t="";e=e||document.querySelector("video");for(var n=0;e&&n<e.buffered.length;n++)t+="["+e.buffered.start(n)+"-"+e.buffered.end(n)+"] ";return t}var o={throttle:function(e,t,n,i,a){var s=this;!s._throttleIds&&(s._throttleIds={}),i&&s.clearThrottle(t),s._throttleIds[t]||(s._throttleIds[t]=setTimeout(function(){a||e(),delete s._throttleIds[t]},n),a&&(a=!1,e()))},clearThrottle:function(e){this._throttleIds&&(clearTimeout(this._throttleIds[e]),delete this._throttleIds[e])},clearAllThrottles:function(){if(this._throttleIds){for(var e in this._throttleIds)clearTimeout(this._throttleIds[e]);this._throttleIds=null}}},d={addEventListener:function(e,t){this.__events=this.__events||{};var n=this.__events[e]=this.__events[e]||[];n.push(t)},removeEventListener:function(e,t){var n=this.__events&&this.__events[e];if(n){n.indexOf(t)}},removeAllEventListeners:function(){this.__events=null},raiseEvent:function(e,t){for(var n=this.__events&&this.__events[e],i=0;n&&i<n.length&&n[i].call(this,t)!==!1;i++);}},u={sessionStateChange:"sessionstatechange",download:"download"},l={manifestDownload:"manifestDownload",manifestParse:"manifestParse",mediaSourceInit:"mediaSourceInit",mediaSourceAppend:"mediaSourceAppend",initSegmentDownload:"initSegmentDownload",mediaSegmentDownload:"fragmentDownload",append:"append"},m={error:-1,idle:0,initializing:1,loading:2,playbackInProgress:4,paused:5},g={error:-1,idle:0,downloading:1,downloaded:2,appending:3,appended:4};window.Dashling=function(){this.settings=e({},Dashling.Settings)},e(Dashling,{Event:u,SessionState:m,FragmentState:g,Error:l}),Dashling.prototype={_streamController:null,_sessionIndex:0,_lastError:null,_state:m.idle,load:function(e,t){var n=this;n.reset(),n._setState(Dashling.initializing),n._videoElement=e,n._initializeMediaSource(e),n._initializeManifest(t)},dispose:function(){this.reset()},reset:function(){var e=this;if(e._streamController&&(e._streamController.dispose(),e._streamController=null),e._parser&&(e._parser.dispose(),e._parser=null),e._videoElement){e.settings.manifest=null;try{e._videoElement.pause()}catch(t){}e._videoElement=null}e.videoElement=null,e._mediaSource=null,e._setState(m.idle)},getRemainingBuffer:function(){return this._streamController?this._streamController.getRemainingBuffer():0},getBufferRate:function(){return this._streamController?this._streamController.getBufferRate():0},getPlayingQuality:function(e){return this._streamController?this._streamController.getPlayingQuality(e):this.settings[e]},getBufferingQuality:function(e){return this._streamController?this._streamController.getBufferingQuality(e):this.settings[e]},getMaxQuality:function(e){var t=this.settings.manifest?this.settings.manifest.streams[e]:null;return t?t.qualities.length-1:0},_setState:function(e,t){this._state!=e&&(this._state=e,this._lastError=t,this.raiseEvent(u.sessionStateChange,{state:e,error:t}))},_initializeMediaSource:function(e){function t(){n.removeEventListener("sourceopen",t),i._sessionIndex==a&&(i._mediaSource=n,i._tryStart())}var n,i=this,a=i._sessionIndex;i.raiseEvent(u.initMediaSourceStart);try{n=new MediaSource}catch(s){i._setState(m.error,Dashling.Error.mediaSourceInit)}n.addEventListener("sourceopen",t,!1),e.autoplay=!1,e.src=window.URL.createObjectURL(n)},_initializeManifest:function(e){function t(e){i._loadIndex==a&&i.state!=m.error&&(i.settings.manifest=e,i._tryStart())}function n(){i._loadIndex==a&&i._setState(m.error,Dashling.Error.manifestFailed)}var i=this,a=i._loadIndex;i.settings.manifest?t(i.settings.manifest):(i._parser=new Dashling.ManifestParser(i.settings),i._parser.addEventListener(Dashling.Event.download,function(e){i.raiseEvent(Dashling.Event.download,e)}),this._parser.parse(e,t,n))},_tryStart:function(){var e=this;e._state!=m.error&&e._mediaSource&&e.settings.manifest&&(e._setState(m.loading),e._mediaSource.duration=e.settings.manifest.mediaDuration,e._streamController=new Dashling.StreamController(e._videoElement,e._mediaSource,e.settings),e._streamController.addEventListener(Dashling.Event.download,function(t){e.raiseEvent(Dashling.Event.download,t)}))}},e(Dashling.prototype,d),Dashling.Settings={manifest:null,startTime:0,isABREnabled:!0,isRBREnabled:!1,targetQuality:{audio:2,video:2},shouldAutoPlay:!0,logToConsole:!0,safeBufferSeconds:15,maxBufferSeconds:119.5,maxConcurrentRequests:{audio:4,video:6},maxSegmentLeadCount:{audio:3,video:5},defaultBandwidth:520,requestTimeout:3e4,maxRetries:3,delaysBetweenRetries:[200,1500,3e3]},Dashling.ManifestParser=function(e){var t=this;t._requestManager=new Dashling.RequestManager(!1,e),t._requestManager.addEventListener(Dashling.Event.download,function(e){t.raiseEvent(u.download,e)})},Dashling.ManifestParser.prototype={_parseIndex:0,dispose:function(){this._requestManager&&(this._requestManager.dispose(),this._requestManager=null)},parse:function(e,t,n){function i(){if(s._parseIndex==r){var e=(o.data,s._parseManifest(o.data));e.request=o,t(e)}}function a(){s._parseIndex==r&&n(o)}var s=this,r=++s._parseIndex,o={url:e,requestType:"manifest"};this._requestManager.load(o,!1,i,a)},_parseManifest:function(e){var t,n={},i=new DOMParser,r=i.parseFromString(e,"text/xml");n.baseUrl=a(r,"BaseURL",""),n.mediaDuration=s(r.documentElement.getAttribute("mediaPresentationDuration")),n.streams={};for(var o=[r.querySelector("AdaptationSet[contentType='audio']"),r.querySelector("AdaptationSet[contentType='video']")],d=0;d<o.length;d++){var u=o[d];if(u){for(var l=u.getAttribute("contentType"),m=u.querySelectorAll("Representation"),g=u.querySelector("SegmentTemplate"),_=u.querySelectorAll("S"),h=n.streams[l]={streamType:l,mimeType:u.getAttribute("mimeType"),codecs:u.getAttribute("codecs"),initUrlFormat:g.getAttribute("initialization"),fragUrlFormat:g.getAttribute("media"),qualities:[],timeline:[]},f=g.getAttribute("timescale"),c=0;c<m.length;c++){var p=m[c],v={id:p.getAttribute("id"),bandwidth:p.getAttribute("bandwidth")};p.getAttribute("height")&&(v.width=Number(p.getAttribute("width")),v.height=Number(p.getAttribute("height"))),h.qualities.push(v)}for(var S=0,y=0;y<_.length;y++){var q=_[y],T=Number(q.getAttribute("r"))||0,I=Number(q.getAttribute("d"));for(t=0;T>=t;t++)h.timeline.push({start:S,startSeconds:S/f,length:I,lengthSeconds:I/f}),S+=I}}}return n}},e(Dashling.ManifestParser.prototype,d),Dashling.StreamController=function(e,n,i){var a=this;a._onVideoSeeking=t(a,a._onVideoSeeking),a._appendNextFragment=t(a,a._appendNextFragment),a._onThrottledSeek=t(a,a._onThrottledSeek),a._videoElement=e,a._videoElement.addEventListener("seeking",a._onVideoSeeking),a._mediaSource=n,a._settings=i,a._startTime=(new Date).getTime(),a._timeSinceLastBuffer=(new Date).getTime(),a._bufferRate=[],a._appendedSeconds=0,a._streams=[a._audioStream=new Dashling.Stream("audio",n,e,i),a._videoStream=new Dashling.Stream("video",n,e,i)];for(var s=0;s<a._streams.length;s++)a._streams[s].addEventListener(Dashling.Event.download,function(e){a.raiseEvent(Dashling.Event.download,e)});a._requestTimerIds=[0,0];var r=a._audioStream.fragments[0].time.lengthSeconds;i.startTime&&r&&(this._appendIndex=Math.max(0,Math.min(a._audioStream.fragments.length-1,Math.floor((i.startTime-.5)/r)))),a._loadNextFragment()},Dashling.StreamController.prototype={_nextStreamIndex:0,_appendIndex:0,_audioDownloadIndex:0,_videoDownloadIndex:0,_simultaneousDownloadsPerStream:2,_maxSegmentsAhead:2,_nextRequestTimerId:0,_seekingTimerId:0,dispose:function(){var e=this;e._videoElement&&(e._videoElement.removeEventListener("seeking",e._onVideoSeeking),e._videoElement=null);for(var t=0;e._streams&&t<e._streams.length;t++)e._streams[t].dispose();e._requestTimerIds[0]&&(clearTimeout(e._requestTimerIds[0]),e._requestTimerIds[0]=0),e._requestTimerIds[1]&&(clearTimeout(e._requestTimerIds[1]),e._requestTimerIds[1]=1),e._seekingTimerId&&(clearTimeout(e._seekingTimerId),e._seekingTimerId=0),e._streams=null,e._mediaSource=null,e.removeAllEventListeners()},getPlayingQuality:function(e){var t=this._videoElement.currentTime,n="video"==e?this._videoStream:e._audioStream,i=Math.floor(t/n.fragments[0].time.lengthSeconds),a=n.fragments[i].qualityIndex;return a>=0?a:n.qualityIndex},getBufferingQuality:function(e){var t="video"==e?this._videoStream:this._audioStream;return t.qualityIndex},getBufferRate:function(){return n(this._bufferRate)},getRemainingBuffer:function(){var e=0;if(this._videoElement)for(var t=this._videoElement.currentTime,n=(this._videoElement.duration-t,this._videoElement.buffered),i=0;i<n.length;i++)if(t>=n.start(i)&&t<=n.end(i)){e=n.end(i)-t;break}return e},getTimeUntilUnderrun:function(){var e=this._videoElement.currentTime,t=this._videoElement.duration-e,n=this.getRemainingBuffer()+.5,i=this.getBufferRate(),a=Number.MAX_VALUE;if(t>n&&1>i){var s=Math.pow(Math.min(1,Math.max(0,n/this._settings.safeBufferSeconds)),2);a=1>i?s*(n/(1-i)):Number.MAX_VALUE}return a},_loadNextFragment:function(){function e(e,n){t._requestTimerIds[e]&&clearTimeout(t._requestTimerIds[e]),t._requestTimerIds[e]=setTimeout(function(){t._requestTimerIds[e]=0,t._loadNextFragment()},n)}var t=this;if(t._streams){for(var n=t._getDownloadCandidates(),i=0;i<n.length;i++)for(var a=n[i],s=t._streams[i],r=0;r<a.length;r++){var o=a[r],d=(s.fragments[o],s.fragments[o-1]),u=d&&d.activeRequest&&d.activeRequest.state==g.downloading?d.activeRequest:null,l=s.getRequestStaggerTime(),m=u?(new Date).getTime()-u.startTime:0;if(u&&!(m>=l)){e(i,l-m);break}s.load(o,this._appendNextFragment)}n[0].length||n[1].length||!n.hitMaxLimit||e(0,300)}},_appendNextFragment:function(){var e,t,n=this,i=this._streams,a=n._settings.startTime||n._videoElement.currentTime;if(i&&i.length){for(;n._appendIndex<i[0].fragments.length;){var s=!0,r=!0;for(t=0;t<i.length;t++)e=i[t],s&=e.canAppend(n._appendIndex),r&=e.fragments[n._appendIndex].state==g.appended&&!e.isMissing(n._appendIndex,a);if(s)for(r=!1,t=0;t<i.length;t++){var e=i[t];e.append(n._appendIndex,n._appendNextFragment),r&=e.fragments[n._appendIndex].state==g.appended}if(!r)break;var o=n._streams[0].fragments[n._appendIndex];if(!o.activeRequest._hasUpdatedBufferRate){o.activeRequest._hasUpdatedBufferRate=!0,n._appendedSeconds+=o.time.lengthSeconds;var d=(new Date).getTime(),u=(d-this._startTime)/1e3;for(n._bufferRate.push(n._appendedSeconds/(u||.1));n._bufferRate.length>3;)n._bufferRate.shift()}n._appendIndex++,n._settings.startTime&&(n._videoElement.currentTime=n._settings.startTime,n._settings.startTime=0);var l=this.getTimeUntilUnderrun()>this._settings.safeBufferSeconds;l&&this._settings.shouldAutoPlay&&!this._hasAutoPlayed&&(this._hasAutoPlayed=!0,this._videoElement.play())}n._appendIndex==i[0].fragments.length&&"open"==n._mediaSource.readyState&&n._mediaSource.endOfStream(),n._loadNextFragment()}},_getDownloadCandidates:function(){var e,t=this,n=[[],[]],a=(t._streams,t._settings),s=t._audioStream.fragments[0].time.lengthSeconds,o=t._settings.startTime||t._videoElement.currentTime,d=Math.floor(o/s),u=d+Math.ceil(a.maxBufferSeconds/s),l=-1,m=-1,_=t._videoStream.fragments.length;for(e=t._appendIndex;u>=e&&_>e;e++){if(this._audioStream.isMissing(e,o)||this._videoStream.isMissing(e,o)){var h=this._videoStream.fragments[e];i("Missing fragment reset: index="+e+" ["+h.time.startSeconds+"] ranges: "+r(t._videoElement),t._settings),this._audioStream.fragments[e].state=this._videoStream.fragments[e].state=g.idle}t._audioStream.assessQuality(),t._videoStream.assessQuality();var f=this._audioStream.canLoad(e),c=this._videoStream.canLoad(e);-1==m&&this._audioStream.fragments[e].state<g.downloaded&&(m=e+a.maxSegmentLeadCount.video),-1==l&&this._videoStream.fragments[e].state<g.downloaded&&(l=e+a.maxSegmentLeadCount.audio);var p=-1==l||l>=e,v=-1==m||m>=e,S=this._audioStream.getActiveRequestCount()+n[0].length+1<a.maxConcurrentRequests.audio,y=this._videoStream.getActiveRequestCount()+n[1].length<a.maxConcurrentRequests.video;if(f&&p&&S&&n[0].push(e),c&&v&&y&&n[1].push(e),!(S&&p||y&&v))break}return e>u&&_>e&&(n.hitMaxLimit=!0),n},_onVideoSeeking:function(){this._seekingTimerId&&clearTimeout(this._seekingTimerId),this._settings.startTime=0,this._seekingTimerId=setTimeout(this._onThrottledSeek,500)},_onThrottledSeek:function(){var e=this,t=e._videoElement.currentTime,n=Math.floor(t/e._streams[0].fragments[0].time.lengthSeconds);if(e._seekingTimerId=0,i("Throttled seek: "+e._videoElement.currentTime,e._settings),e._nextRequestTimerId&&(clearTimeout(e._nextRequestTimerId),e._nextRequestTimerId=0),e._appendIndex<n)for(var a=0;a<e._streams.length;a++)e._streams[a].abortAll();e._appendIndex=n,e._appendNextFragment()}},e(Dashling.StreamController.prototype,d),e(Dashling.StreamController.prototype,o);var _="Dashling.Stream.bandwidth";Dashling.Stream=function(t,n,i,a){var s=this,r=a.manifest.streams[t];e(s,{fragments:[],qualityIndex:Math.max(0,Math.min(r.qualities.length-1,a.targetQuality[t])),_startTime:(new Date).getTime(),_appendLength:0,_initializedQualityIndex:-1,_initRequestManager:new Dashling.RequestManager(!1,a),_requestManager:new Dashling.RequestManager("video"==t,a),_streamType:t,_mediaSource:n,_videoElement:i,_settings:a,_manifest:a.manifest,_streamInfo:r,_buffer:null,_bufferRate:[],_initSegments:[]}),s._requestManager.addEventListener(Dashling.Event.download,function(e){s.raiseEvent(u.download,e)}),s._initRequestManager.addEventListener(Dashling.Event.download,function(e){s.raiseEvent(u.download,e)});for(var o=r.timeline.length,d=0;o>d;d++)s.fragments.push({state:g.idle,qualityIndex:-1,qualityId:"",requestType:"media",fragmentIndex:d,time:r.timeline[d],activeRequest:null,requests:[]})},Dashling.Stream.prototype={dispose:function(){this.clearAllThrottles(),this._requestManager&&(this._requestManager.dispose(),this._requestManager=null),this.removeAllEventListeners()},abortAll:function(){this._requestManager.abortAll()},canAppend:function(e){var t=this.fragments[e],n=t?this._initSegments[t.qualityIndex]:null,i=this._initSegments[this._streamInfo.qualities.length-1];return t&&t.state==g.downloaded&&n&&n.state>=g.downloaded&&i&&i.state>=g.downloaded},append:function(e,t){function n(){var e=d[0];if(d.length){u.addEventListener("update",a);try{i("Append started: "+s._streamType+" "+e.qualityId+" "+e.requestType+" "+(void 0!==e.fragmentIndex?"index "+e.fragmentIndex:""),s._settings),u.appendBuffer(e.data)}catch(n){e.state=r.state=g.error,s._isAppending=!1,t()}}else{r.state=g.appended,s._isAppending=!1;var o=((new Date).getTime()-s._startTime)/1e3;s._appendLength+=r.time.lengthSeconds,s._bufferRate.push(s._appendLength/o),s._bufferRate.length>3&&s._bufferRate.shift(),t(r)}}function a(){var t=d[0];u.removeEventListener("update",a),s.isFragmentLoaded(e,s._videoElement.currentTime)&&console.log("Buffer couldn't get appended!!!!!!!1"),t.timeAtAppended=(new Date).getTime()-t.startTime,t.state=g.appended,t.clearDataAfterAppend&&(t.data=null),"init"===t.requestType&&(s._initializedQualityIndex=t.qualityIndex),i("Append complete: "+s._streamType+" "+t.qualityId+" "+t.requestType+" "+(void 0!==t.fragmentIndex?"index "+t.fragmentIndex:""),s._settings),d.shift(),n()}var s=this,r=s.fragments[e],o=s._streamInfo.qualities.length-1,d=[],u=s._buffer;!s._isAppending&&r&&r.state===g.downloaded&&(s._isAppending=!0,r.state=g.appending,u||(u=s._getSourceBuffer(),o>r.qualityIndex&&d.push(s._initSegments[o])),d.push(s._initSegments[r.qualityIndex]),d.push(r.activeRequest),n())},getBufferRate:function(){return n(this._bufferRate)},getActiveRequestCount:function(){return this._requestManager.getActiveRequestCount()},getRequestStaggerTime:function(){return Math.round(1.4*this._getDownloadMsForQuality(this.qualityIndex))},isMissing:function(e,t){return n.state==g.appended&&!this.isFragmentLoaded(e,t);var n},isFragmentLoaded:function(e,t){var n=this.fragments[e];return n.state==g.appended&&!this.isBuffered(e,t)},isBuffered:function(e,t){var n=this.fragments[e],i=!1;if(n){var a=this._buffer.buffered,s=n.time,r=s.startSeconds<.3,o=s.startSeconds+s.lengthSeconds+.3>=this._manifest.mediaDuration,d=Math.max(t,s.startSeconds+(r?.5:.05)),u=s.startSeconds+s.lengthSeconds-(o?.8:.05);try{for(var l=0;l<a.length;l++)if(a.start(l)<=d&&a.end(l)>u){i=!0;break}}catch(m){i=!0}}return i},canLoad:function(e){return this.fragments[e].state<=g.idle},load:function(e,t){function n(e){r.state=g.downloaded;var n=Math.round(e.timeAtLastByte-(e.timeAtEstimatedFirstByte||e.timeAtFirstByte)),a=e.timeAtLastByte-n;i("Download complete: "+e.qualityId+" "+e.requestType+" index: "+e.fragmentIndex+" waiting: "+a+"ms receiving: "+n,s._settings),t(r)}function a(){o.isAborted?(r.state=g.idle,r.activeRequest=null,r.requests=[]):r.state=g.error}var s=this,r=this.fragments[e];if(r&&r.state<=g.idle){r.state=g.downloading,r.qualityIndex=s.qualityIndex,r.qualityId=this._streamInfo.qualities[r.qualityIndex].id,s._loadInitSegment(this.qualityIndex,t);var o={url:s._getUrl(e,r),state:g.downloading,fragmentIndex:e,requestType:"media",qualityIndex:r.qualityIndex,qualityId:r.qualityId,clearDataAfterAppend:!0};r.activeRequest=o,r.requests.push(o),i("Download started: "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index="+o.fragmentIndex:"")+" time="+((new Date).getTime()-s._startTime)+"ms stagger="+s.getRequestStaggerTime()+"ms",s._settings),s._requestManager.load(o,!0,n,a)}},assessQuality:function(){var e=this,t=e._settings,n=e._requestManager.getAverageBandwidth(),a=e._streamInfo.qualities.length-1;if(n?"video"===this._streamType&&localStorage.setItem(_,n):n=parseFloat(localStorage.getItem(_)),t.isABREnabled&&n)if(t.isRBREnabled)e.qualityIndex=Math.round(Math.random()*a);else{for(var s=0,r="Quality check "+e._streamType+": bps="+Math.round(1e3*n),o=e._streamInfo.timeline[0].lengthSeconds,d=.4*o,u=0;a>=u;u++){var l=e._getDownloadMsForQuality(u,0,n);r+=" "+u+"="+Math.round(l)+"ms",o>l/1e3+d&&(s=u)}e.throttle(function(){i(r,e._settings)},"assess",1e3,!1,!1),e.qualityIndex=s}else e.qualityIndex=Math.min(e._streamInfo.qualities.length-1,t.targetQuality[e._streamType])},_getDownloadMsForQuality:function(e,t){var n=this,i=n._streamInfo.qualities[e],a=n._streamInfo.timeline[t||0].lengthSeconds,s=i.bandwidth/8,r=s*a,o=n._requestManager.getAverageBandwidth();o?"video"===this._streamType&&localStorage.setItem(_,o):o=parseFloat(localStorage.getItem(_));var d=o||n._settings.defaultBandwidth;return r/d},_getSourceBuffer:function(){return this._buffer||(this._buffer=this._mediaSource.addSourceBuffer(this._streamInfo.mimeType+";codecs="+this._streamInfo.codecs)),this._buffer},_loadInitSegment:function(e,t){function n(){o.state=g.downloaded,i("Download complete: "+s._streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),s._settings),t(o)}function a(){o.state=g.error}var s=this,r=this._streamInfo.qualities.length-1;if(e!=r&&s._loadInitSegment(r,t),!s._initSegments[e]){var o=s._initSegments[e]={url:this._getInitUrl(e),state:g.downloading,timeAtDownloadStarted:(new Date).getTime(),requestType:"init",qualityIndex:e,qualityId:this._streamInfo.qualities[e].id};i("Download started: "+s._streamType+" "+o.qualityId+" "+o.requestType+" "+(void 0!==o.fragmentIndex?"index "+o.fragmentIndex:""),s._settings),s._initRequestManager.load(o,!0,n,a)}},_getInitUrl:function(e){var t=this._streamInfo.initUrlFormat.replace("$RepresentationID$",this._streamInfo.qualities[e].id);return this._manifest.baseUrl+t},_getUrl:function(e,t){var n=this._streamInfo.fragUrlFormat.replace("$RepresentationID$",t.qualityId).replace("$Time$",t.time.start);return this._manifest.baseUrl+n}},e(Dashling.Stream.prototype,d),e(Dashling.Stream.prototype,o),Dashling.RequestManager=function(t,n){e(this,{_settings:n,_activeRequests:{},_waitTimes:[],_receiveTimes:[],_bandwidths:[],_shouldRecordStats:t,_maxRetries:n.maxRetries,_delaysBetweenRetries:n.delaysBetweenRetries})};Dashling.RequestManager.prototype={_activeRequestCount:0,_totalRequests:0,_xhrType:XMLHttpRequest,dispose:function(){this.abortAll(),this.removeAllEventListeners()},getActiveRequestCount:function(){return this._activeRequestCount},abortAll:function(){for(var e in this._activeRequests){var t=this._activeRequests[e];i("Aborting request: "+t.url),t.isAborted=!0,t.abort()}this._activeRequests={}},load:function(e,t,n,i){function a(){function u(){0==l.status&&e.timeAtLastByte>=s._settings.requestTimeout&&(l.isTimedOut=!0),!l.isAborted&&++o<r?(e.retryCount++,setTimeout(a,d[Math.min(d.length-1,o)])):(e.state=g.error,e.hasError=!0,e.isAborted=l.isAborted,e.statusCode=l.isAborted?"aborted":l.isTimedOut?"timeout":l.status,i&&i(e))}var l=new s._xhrType,m=++s._totalRequests;s._activeRequests[m]=l,s._activeRequestCount++,l.url=e.url,l.open("GET",e.url,!0),t&&(l.responseType="arraybuffer"),l.timeout=s._settings.requestTimeout,l.onreadystatechange=function(){l.readyState>0&&e.timeAtFirstByte<0&&(e.timeAtFirstByte=(new Date).getTime()-e.startTime)},l.onprogress=function(t){e.progressEvents.push({timeFromStart:(new Date).getTime()-e.startTime,bytesLoaded:t.lengthComputable?t.loaded:-1}),s._postProgress(e.progressEvents)},l.onloadend=function(){if(delete s._activeRequests[m],s._activeRequestCount--,e.timeAtLastByte=(new Date).getTime()-e.startTime,l.status>=200&&l.status<=299){if(e.bytesLoaded=t?l.response.byteLength:l.responseText.length,l.onreadystatechange(),e.progressEvents.length>1){var i=e.progressEvents[e.progressEvents.length-1],a=e.progressEvents[0],r=i.timeFromStart-a.timeFromStart,o=i.bytesLoaded-a.bytesLoaded;e.bytesPerMillisecond=o/r,e.timeAtEstimatedFirstByte=e.timeAtLastByte-e.bytesLoaded/e.bytesPerMillisecond}s._waitTimes.push(e.timeAtEstimatedFirstByte),s._receiveTimes.push(e.timeAtLastByte-e.timeAtEstimatedFirstByte),e.data=t?new Uint8Array(l.response):l.responseText,e.statusCode=l.status,e.state=g.downloaded,n&&n(e)}else u(e);s.raiseEvent(Dashling.Event.download,e)},e.state=g.downloading,e.progressEvents=[],e.timeAtFirstByte=-1,e.timeAtLastByte=-1,e.startTime=(new Date).getTime(),l.send()}var s=this,r=this._maxRetries,o=-1,d=this._delaysBetweenRetries;e.retryCount=0,a()},_postProgress:function(e){if(e.length>1){var t=e[e.length-1],n=e[0],i=t.bytesLoaded-n.bytesLoaded;if(i>1e4){var a=t.timeFromStart-n.timeFromStart;if(a>1){var s=i/a;for(this._bandwidths.push(s);this._bandwidths.length>10;)this._bandwidths.shift()}}}},getAverageWait:function(){return n(this._waitTimes,this._waitTimes.length-5)},getAverageReceive:function(){return n(this._receiveTimes,this._receiveTimes.length-5)},getAverageBandwidth:function(){var e=n(this._bandwidths,this._bandwidths.length-5);return e}},e(Dashling.RequestManager.prototype,d)}();